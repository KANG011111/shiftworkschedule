{% extends "base.html" %}

{% block title %}一鍵匯出月大表 - 班表管理系統{% endblock %}

{% block content %}
<h2 class="mb-3">
    <i class="fas fa-download d-md-none"></i>
    一鍵匯出月大表
</h2>

<div class="row">
    <div class="col-lg-8 col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-file-excel"></i> 匯出設定</h5>
            </div>
            <div class="card-body">
                <form id="exportForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="searchQuery" class="form-label">員工姓名或工號</label>
                            <input type="text" class="form-control form-control-lg" id="searchQuery" name="query" 
                                   placeholder="輸入姓名如：李惟綱 或工號如：EMP_056" required>
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i> 支援模糊搜尋，如輸入「李」可找到所有姓李的員工
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="exportYear" class="form-label">年份</label>
                            <select class="form-select form-select-lg" id="exportYear" name="year" required>
                                <option value="">選擇年份</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="exportMonth" class="form-label">月份</label>
                            <select class="form-select form-select-lg" id="exportMonth" name="month" required>
                                <option value="">選擇月份</option>
                                <option value="1">1月</option>
                                <option value="2">2月</option>
                                <option value="3">3月</option>
                                <option value="4">4月</option>
                                <option value="5">5月</option>
                                <option value="6">6月</option>
                                <option value="7">7月</option>
                                <option value="8">8月</option>
                                <option value="9">9月</option>
                                <option value="10">10月</option>
                                <option value="11">11月</option>
                                <option value="12">12月</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-info btn-lg me-md-2" onclick="previewSchedule()">
                            <i class="fas fa-eye me-2"></i>預覽班表
                        </button>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-download me-2"></i>匯出JPG圖片
                        </button>
                    </div>
                </form>
                
                <div id="exportStatus" class="mt-3"></div>
                
                <!-- 班表預覽區域 -->
                <div id="schedulePreview" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-calendar-alt"></i> 班表預覽</h5>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-success" onclick="downloadJPG()">
                                    <i class="fas fa-image me-1"></i>下載JPG
                                </button>
                                <button type="button" class="btn btn-primary" onclick="downloadICS()">
                                    <i class="fas fa-calendar-plus me-1"></i>下載ICS
                                </button>
                            </div>
                        </div>
                        <div class="card-body text-center">
                            <div id="calendarPreview" class="calendar-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 col-md-12 mt-3 mt-lg-0">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> 使用說明</h5>
            </div>
            <div class="card-body">
                <h6>搜尋方式：</h6>
                <ul>
                    <li><strong>姓名搜尋：</strong>輸入全名或部分姓名</li>
                    <li><strong>工號搜尋：</strong>輸入員工代碼</li>
                </ul>
                
                <h6 class="mt-3">匯出內容：</h6>
                <ul>
                    <li>完整月度排班資料</li>
                    <li>日期、星期、班別資訊</li>
                    <li>上下班時間</li>
                    <li>Excel格式，方便編輯</li>
                </ul>
                
                <h6 class="mt-3">檔案格式：</h6>
                <ul class="small text-muted">
                    <li><strong>JPG圖片：</strong>員工姓名_年月_班表.jpg</li>
                    <li><strong>ICS日曆：</strong>員工姓名_年月_班表.ics</li>
                </ul>
                <p class="small text-muted">
                    <i class="fas fa-info-circle"></i> ICS檔案可直接匯入Google日曆、iPhone日曆、Outlook等
                </p>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-lightbulb"></i> 燈光組快速搜尋</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2" id="lightingMembersButtons">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> 載入燈光組人員中...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- HTML to Canvas 庫 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
.calendar-container {
    max-width: 400px;
    margin: 0 auto;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    overflow: hidden;
}

.calendar-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    text-align: center;
    font-weight: bold;
    font-size: 18px;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #e5e5e5;
    padding: 1px;
}

.weekday-header {
    background: #f8f9fa;
    padding: 8px 4px;
    text-align: center;
    font-size: 12px;
    font-weight: bold;
    color: #6c757d;
}

.calendar-day {
    background: white;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    position: relative;
}

.calendar-day.empty {
    background: #f8f9fa;
    color: #adb5bd;
}

.day-number {
    font-weight: bold;
    margin-bottom: 2px;
}

.shift-badge {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    margin-top: 2px;
}

/* 班別顏色 */
.shift-fc { background-color: #007bff; }
.shift-p1 { background-color: #28a745; }
.shift-p2 { background-color: #ffc107; color: #000; }
.shift-p3 { background-color: #fd7e14; }
.shift-p4 { background-color: #dc3545; }
.shift-h { background-color: #6c757d; }

.calendar-legend {
    padding: 15px;
    background: #f8f9fa;
    border-top: 1px solid #e5e5e5;
}

.legend-item {
    display: inline-block;
    margin: 2px 8px;
    font-size: 12px;
}

.legend-color {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 2px;
    margin-right: 4px;
    vertical-align: middle;
}
</style>

<script>
// 初始化年份選項
function initializeYearOptions() {
    const yearSelect = document.getElementById('exportYear');
    const currentYear = new Date().getFullYear();
    
    // 添加當前年份和前後各2年
    for (let year = currentYear - 2; year <= currentYear + 2; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + '年';
        if (year === currentYear) {
            option.selected = true;
        }
        yearSelect.appendChild(option);
    }
}

// 載入可用年月資料並設定預設值
async function loadAvailableMonths() {
    console.log('🔄 [DEBUG] 開始載入可用日期範圍...');
    try {
        const response = await fetch('/api/date_range');
        const dateRange = await response.json();
        
        console.log('📊 [DEBUG] 日期範圍資料:', dateRange);
        
        if (dateRange.available_months) {
            const months = Object.values(dateRange.available_months);
            console.log('📅 [DEBUG] 可用月份數量:', months.length);
            console.log('📅 [DEBUG] 可用月份詳情:', months);
            
            if (months.length > 0) {
                document.getElementById('exportYear').value = months[0].year;
                document.getElementById('exportMonth').value = months[0].month;
                console.log('✅ [DEBUG] 預設日期設定:', `${months[0].year}年${months[0].month}月`);
            }
        }
    } catch (error) {
        console.error('❌ [DEBUG] 載入日期範圍失敗:', error);
    }
}

// 快速填入員工工號
function fillEmployee(employeeCode) {
    document.getElementById('searchQuery').value = employeeCode;
    // 隱藏之前的預覽結果
    document.getElementById('schedulePreview').style.display = 'none';
    document.getElementById('exportStatus').innerHTML = '';
}

// 預覽班表
async function previewSchedule() {
    const query = document.getElementById('searchQuery').value.trim();
    const year = document.getElementById('exportYear').value;
    const month = document.getElementById('exportMonth').value;
    
    console.log('🔍 [DEBUG] 開始預覽班表...');
    console.log('📝 [DEBUG] 搜尋參數:', { query, year, month });
    
    if (!query || !year || !month) {
        console.error('❌ [DEBUG] 參數不完整:', { query, year, month });
        alert('請填寫完整資訊');
        return;
    }
    
    const statusDiv = document.getElementById('exportStatus');
    statusDiv.innerHTML = `
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            正在載入班表預覽...
        </div>
    `;
    
    try {
        // 獲取員工班表資料
        const params = new URLSearchParams({ query, year, month });
        const apiUrl = `/api/preview_schedule?${params.toString()}`;
        
        console.log('🌐 [DEBUG] API請求URL:', apiUrl);
        console.log('📡 [DEBUG] 發送API請求...');
        
        const startTime = performance.now();
        const response = await fetch(apiUrl);
        const endTime = performance.now();
        const responseTime = Math.round(endTime - startTime);
        
        console.log('⏱️ [DEBUG] API回應時間:', `${responseTime}ms`);
        console.log('📊 [DEBUG] HTTP狀態碼:', response.status);
        console.log('📊 [DEBUG] Response headers:', Object.fromEntries(response.headers.entries()));
        
        const data = await response.json();
        console.log('📊 [DEBUG] API回應資料:', data);
        
        if (!response.ok) {
            console.error('❌ [DEBUG] API回應錯誤:', data);
            throw new Error(data.error || '載入失敗');
        }
        
        // 檢查是否返回多個匹配員工
        if (data.multiple_matches) {
            console.log('🔍 [DEBUG] 找到多個匹配員工，顯示選擇列表');
            console.log('👥 [DEBUG] 匹配員工列表:', data.choices);
            showEmployeeChoices(data.choices, year, month, query);
            return;
        }
        
        // 分析回應資料
        console.log('👤 [DEBUG] 找到員工:', data.employee);
        console.log('📅 [DEBUG] 目標年月:', `${data.year}年${data.month}月`);
        console.log('📊 [DEBUG] 排班記錄數量:', data.schedules.length);
        
        if (data.schedules.length > 0) {
            console.log('📊 [DEBUG] 排班記錄範例:', data.schedules.slice(0, 3));
            const shiftTypes = [...new Set(data.schedules.map(s => s.shift_code))];
            console.log('🎯 [DEBUG] 包含的班別類型:', shiftTypes);
        } else {
            console.log('⚠️ [DEBUG] 該月份無排班記錄');
        }
        
        console.log('📅 [DEBUG] 月曆結構:', data.calendar);
        
        // 生成月曆預覽
        console.log('🎨 [DEBUG] 開始生成月曆預覽...');
        generateCalendarPreview(data);
        
        // 顯示預覽區域
        document.getElementById('schedulePreview').style.display = 'block';
        statusDiv.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> 班表預覽已生成！
            </div>
        `;
        
        console.log('✅ [DEBUG] 班表預覽生成完成');
        console.log('📊 [DEBUG] 篩選結果統計:', {
            員工姓名: data.employee.name,
            員工代碼: data.employee.employee_code,
            目標月份: `${data.year}年${data.month}月`,
            排班天數: data.schedules.length,
            API回應時間: `${responseTime}ms`
        });
        
        // 滾動到預覽區域
        document.getElementById('schedulePreview').scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        console.error('❌ [DEBUG] 預覽失敗:', error);
        console.error('❌ [DEBUG] 錯誤詳情:', {
            名稱: error.name,
            訊息: error.message,
            堆疊: error.stack
        });
        
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> ${error.message}
            </div>
        `;
    }
}

// 生成月曆預覽HTML
function generateCalendarPreview(data) {
    const { employee, year, month, schedules, calendar } = data;
    
    const monthNames = ['', '1月', '2月', '3月', '4月', '5月', '6月', 
                       '7月', '8月', '9月', '10月', '11月', '12月'];
    
    const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
    
    // 建立班表資料字典
    const scheduleMap = {};
    schedules.forEach(schedule => {
        const day = new Date(schedule.date).getDate();
        scheduleMap[day] = schedule;
    });
    
    // 生成標題
    let html = `
        <div class="calendar-header">
            ${employee.name} 個人班表<br>
            <small>工號: ${employee.employee_code} | ${year}年${monthNames[month]}</small>
        </div>
        <div class="calendar-grid">
    `;
    
    // 生成星期標題
    weekdays.forEach(day => {
        html += `<div class="weekday-header">星期${day}</div>`;
    });
    
    // 生成日期格子
    calendar.forEach(week => {
        week.forEach(day => {
            if (day === 0) {
                html += `<div class="calendar-day empty"></div>`;
            } else {
                const schedule = scheduleMap[day];
                const shiftClass = schedule ? getShiftClass(schedule.shift_code) : '';
                
                html += `
                    <div class="calendar-day">
                        <div class="day-number">${day}</div>
                        ${schedule ? `<div class="shift-badge ${shiftClass}">${schedule.shift_code}</div>` : ''}
                    </div>
                `;
            }
        });
    });
    
    html += `</div>`;
    
    // 添加圖例
    const usedShifts = [...new Set(schedules.map(s => s.shift_code))].sort();
    if (usedShifts.length > 0) {
        html += `<div class="calendar-legend">`;
        html += `<strong>班別說明：</strong><br>`;
        usedShifts.forEach(shift => {
            const shiftClass = getShiftClass(shift);
            const shiftName = schedules.find(s => s.shift_code === shift)?.shift_name || shift;
            html += `
                <div class="legend-item">
                    <span class="legend-color ${shiftClass}"></span>
                    ${shift}: ${shiftName}
                </div>
            `;
        });
        html += `</div>`;
    }
    
    document.getElementById('calendarPreview').innerHTML = html;
}

// 取得班別CSS類別
function getShiftClass(shiftCode) {
    if (shiftCode.includes('FC')) return 'shift-fc';
    if (shiftCode.includes('P1')) return 'shift-p1';
    if (shiftCode.includes('P2')) return 'shift-p2';
    if (shiftCode.includes('P3')) return 'shift-p3';
    if (shiftCode.includes('P4')) return 'shift-p4';
    if (shiftCode.includes('H')) return 'shift-h';
    return 'shift-fc'; // 預設
}

// 下載JPG
async function downloadJPG() {
    console.log('📸 [DEBUG] 開始JPG圖片下載...');
    
    const calendarElement = document.getElementById('calendarPreview');
    
    if (!calendarElement.innerHTML) {
        console.error('❌ [DEBUG] 沒有可下載的班表預覽');
        alert('請先預覽班表');
        return;
    }
    
    try {
        // 取得檔案資訊
        const query = document.getElementById('searchQuery').value.trim();
        const year = document.getElementById('exportYear').value;
        const month = document.getElementById('exportMonth').value;
        const monthStr = month.toString().padStart(2, '0');
        const fileName = `${query}_${year}年${monthStr}月_班表.jpg`;
        
        console.log('📁 [DEBUG] 目標檔案名:', fileName);
        console.log('🎨 [DEBUG] 開始HTML轉換為Canvas...');
        
        const startTime = performance.now();
        const canvas = await html2canvas(calendarElement, {
            backgroundColor: '#ffffff',
            scale: 2, // 提高解析度
            useCORS: true,
            allowTaint: true
        });
        const endTime = performance.now();
        const renderTime = Math.round(endTime - startTime);
        
        console.log('⏱️ [DEBUG] Canvas渲染時間:', `${renderTime}ms`);
        console.log('📊 [DEBUG] Canvas尺寸:', `${canvas.width}x${canvas.height}`);
        
        // 轉換為JPG並下載
        canvas.toBlob(function(blob) {
            const fileSizeKB = Math.round(blob.size / 1024);
            console.log('📊 [DEBUG] JPG檔案大小:', `${fileSizeKB}KB`);
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('✅ [DEBUG] JPG檔案下載完成');
            console.log('📊 [DEBUG] JPG匯出統計:', {
                檔案名稱: fileName,
                檔案大小: `${fileSizeKB}KB`,
                圖片尺寸: `${canvas.width}x${canvas.height}`,
                渲染時間: `${renderTime}ms`,
                圖片質量: '90%'
            });
            
            document.getElementById('exportStatus').innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> JPG圖片已下載！
                </div>
            `;
        }, 'image/jpeg', 0.9);
        
    } catch (error) {
        console.error('❌ [DEBUG] JPG下載失敗:', error);
        console.error('❌ [DEBUG] 錯誤詳情:', {
            名稱: error.name,
            訊息: error.message,
            堆疊: error.stack
        });
        alert('下載失敗，請稍後再試');
    }
}

// 下載ICS日曆檔案
async function downloadICS() {
    console.log('📅 [DEBUG] 開始ICS日曆檔案下載...');
    
    const query = document.getElementById('searchQuery').value.trim();
    const year = document.getElementById('exportYear').value;
    const month = document.getElementById('exportMonth').value;
    
    console.log('📝 [DEBUG] ICS下載參數:', { query, year, month });
    
    if (!query || !year || !month) {
        console.error('❌ [DEBUG] ICS下載參數不完整:', { query, year, month });
        alert('請先預覽班表');
        return;
    }
    
    try {
        const statusDiv = document.getElementById('exportStatus');
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                正在生成ICS日曆檔案...
            </div>
        `;
        
        // 呼叫ICS匯出API，確保正確編碼
        const params = new URLSearchParams();
        params.append('query', query);
        params.append('year', year);
        params.append('month', month);
        const apiUrl = `/api/export_ics?${params.toString()}`;
        
        console.log('🌐 [DEBUG] ICS API請求URL:', apiUrl);
        console.log('📡 [DEBUG] 發送ICS API請求...');
        
        const startTime = performance.now();
        const response = await fetch(apiUrl);
        const endTime = performance.now();
        const responseTime = Math.round(endTime - startTime);
        
        console.log('⏱️ [DEBUG] ICS API回應時間:', `${responseTime}ms`);
        console.log('📊 [DEBUG] ICS HTTP狀態碼:', response.status);
        console.log('📊 [DEBUG] ICS Response headers:', Object.fromEntries(response.headers.entries()));
        
        if (!response.ok) {
            const error = await response.json();
            console.error('❌ [DEBUG] ICS API回應錯誤:', error);
            throw new Error(error.error || '下載失敗');
        }
        
        // 下載檔案
        console.log('📁 [DEBUG] 開始處理ICS檔案blob...');
        const blob = await response.blob();
        const fileSizeKB = Math.round(blob.size / 1024);
        
        console.log('📊 [DEBUG] ICS檔案大小:', `${fileSizeKB}KB`);
        console.log('📊 [DEBUG] ICS檔案類型:', blob.type);
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        const monthStr = month.toString().padStart(2, '0');
        const fileName = `${query}_${year}年${monthStr}月_班表.ics`;
        
        console.log('📁 [DEBUG] ICS檔案名稱:', fileName);
        
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        console.log('✅ [DEBUG] ICS檔案下載完成');
        console.log('📊 [DEBUG] ICS匯出統計:', {
            檔案名稱: fileName,
            檔案大小: `${fileSizeKB}KB`,
            檔案格式: 'ICS (iCalendar)',
            API回應時間: `${responseTime}ms`,
            內容類型: blob.type || 'text/calendar'
        });
        
        statusDiv.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> ICS日曆檔案已下載！可匯入到您的日曆應用程式
            </div>
        `;
        
    } catch (error) {
        console.error('❌ [DEBUG] ICS下載失敗:', error);
        console.error('❌ [DEBUG] ICS錯誤詳情:', {
            名稱: error.name,
            訊息: error.message,
            堆疊: error.stack
        });
        
        document.getElementById('exportStatus').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> ${error.message}
            </div>
        `;
    }
}

// 修改原本的表單提交處理（現在也支援預覽）
document.getElementById('exportForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    previewSchedule(); // 直接呼叫預覽功能
});

// 載入燈光組人員列表
async function loadLightingMembers() {
    console.log('👥 [DEBUG] 開始載入燈光組人員列表...');
    try {
        const response = await fetch('/api/group-members');
        const result = await response.json();
        
        console.log('📊 [DEBUG] 群組人員API回應:', result);
        
        if (result.status === 'success' && result.data.燈光組) {
            const members = result.data.燈光組;
            console.log('👥 [DEBUG] 燈光組人員數量:', members.length);
            console.log('👥 [DEBUG] 燈光組人員名單:', members);
            
            const buttonsContainer = document.getElementById('lightingMembersButtons');
            
            if (members.length === 0) {
                console.log('⚠️  [DEBUG] 燈光組人員名單為空');
                buttonsContainer.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle"></i> 尚未設定燈光組人員名單
                    </div>
                `;
            } else {
                // 生成人員按鈕
                const colors = ['primary', 'secondary', 'info', 'success', 'warning', 'danger'];
                const buttons = members.map((member, index) => {
                    const colorClass = colors[index % colors.length];
                    return `
                        <button class="btn btn-outline-${colorClass} btn-sm" onclick="fillEmployee('${member}')">
                            ${member}
                        </button>
                    `;
                }).join('');
                
                console.log('🎨 [DEBUG] 生成按鈕HTML完成');
                buttonsContainer.innerHTML = buttons;
            }
            
        } else if (result.message === '需要登入') {
            console.log('🔐 [DEBUG] 用戶未登入');
            // 用戶未登入，顯示提示
            document.getElementById('lightingMembersButtons').innerHTML = `
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle"></i> 請先登入以查看燈光組人員名單
                </div>
            `;
            return;
        } else {
            throw new Error(result.message || '載入失敗');
        }
    } catch (error) {
        console.error('❌ [DEBUG] 載入燈光組人員失敗:', error);
        document.getElementById('lightingMembersButtons').innerHTML = `
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle"></i> ${error.message || '載入人員名單失敗'}
            </div>
        `;
        document.getElementById('memberCount').textContent = '載入失敗';
    }
}

// 顯示員工選擇列表
function showEmployeeChoices(choices, year, month, originalQuery) {
    console.log('👥 [DEBUG] 開始生成員工選擇界面');
    console.log('📝 [DEBUG] 選擇參數:', { choices, year, month, originalQuery });
    
    const statusDiv = document.getElementById('exportStatus');
    
    // 生成選擇按鈕
    const choiceButtons = choices.map((employee, index) => {
        const colorClasses = ['primary', 'success', 'info', 'warning', 'danger', 'secondary'];
        const colorClass = colorClasses[index % colorClasses.length];
        
        return `
            <button class="btn btn-outline-${colorClass} btn-lg me-2 mb-2" 
                    onclick="selectEmployee('${employee.id}', '${year}', '${month}', '${employee.name}', '${employee.employee_code}')">
                <i class="fas fa-user me-2"></i>
                <strong>${employee.name}</strong>
                <br>
                <small class="text-muted">${employee.employee_code}</small>
            </button>
        `;
    }).join('');
    
    statusDiv.innerHTML = `
        <div class="alert alert-warning">
            <h5><i class="fas fa-users me-2"></i>找到多個員工匹配「${originalQuery}」</h5>
            <p class="mb-3">請選擇要查看班表的員工：</p>
            <div class="d-flex flex-wrap">
                ${choiceButtons}
            </div>
            <hr>
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                提示：您也可以輸入更完整的姓名或工號來直接定位特定員工
            </small>
        </div>
    `;
    
    // 隱藏之前的預覽結果
    document.getElementById('schedulePreview').style.display = 'none';
    
    console.log('✅ [DEBUG] 員工選擇界面生成完成');
}

// 處理員工選擇
async function selectEmployee(employeeId, year, month, employeeName, employeeCode) {
    console.log('🎯 [DEBUG] 用戶選擇員工:', { employeeId, year, month, employeeName, employeeCode });
    
    const statusDiv = document.getElementById('exportStatus');
    statusDiv.innerHTML = `
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            正在載入 ${employeeName} (${employeeCode}) 的班表...
        </div>
    `;
    
    try {
        // 更新搜尋框內容
        document.getElementById('searchQuery').value = employeeName;
        
        // 呼叫新的API端點
        const params = new URLSearchParams({ employee_id: employeeId, year, month });
        const apiUrl = `/api/preview_schedule_by_id?${params.toString()}`;
        
        console.log('🌐 [DEBUG] 選擇員工API請求URL:', apiUrl);
        console.log('📡 [DEBUG] 發送選擇員工API請求...');
        
        const startTime = performance.now();
        const response = await fetch(apiUrl);
        const endTime = performance.now();
        const responseTime = Math.round(endTime - startTime);
        
        console.log('⏱️ [DEBUG] 選擇員工API回應時間:', `${responseTime}ms`);
        console.log('📊 [DEBUG] 選擇員工HTTP狀態碼:', response.status);
        
        const data = await response.json();
        console.log('📊 [DEBUG] 選擇員工API回應資料:', data);
        
        if (!response.ok) {
            console.error('❌ [DEBUG] 選擇員工API回應錯誤:', data);
            throw new Error(data.error || '載入失敗');
        }
        
        // 分析回應資料
        console.log('👤 [DEBUG] 選擇的員工資料:', data.employee);
        console.log('📅 [DEBUG] 選擇的目標年月:', `${data.year}年${data.month}月`);
        console.log('📊 [DEBUG] 選擇的排班記錄數量:', data.schedules.length);
        
        if (data.schedules.length > 0) {
            console.log('📊 [DEBUG] 選擇的排班記錄範例:', data.schedules.slice(0, 3));
            const shiftTypes = [...new Set(data.schedules.map(s => s.shift_code))];
            console.log('🎯 [DEBUG] 選擇的包含班別類型:', shiftTypes);
        } else {
            console.log('⚠️ [DEBUG] 該員工該月份無排班記錄');
        }
        
        // 生成月曆預覽
        console.log('🎨 [DEBUG] 開始生成選擇員工的月曆預覽...');
        generateCalendarPreview(data);
        
        // 顯示預覽區域
        document.getElementById('schedulePreview').style.display = 'block';
        statusDiv.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> 
                已載入 <strong>${employeeName}</strong> (${employeeCode}) 的班表預覽！
            </div>
        `;
        
        console.log('✅ [DEBUG] 選擇員工的班表預覽生成完成');
        console.log('📊 [DEBUG] 選擇員工的篩選結果統計:', {
            員工姓名: data.employee.name,
            員工代碼: data.employee.employee_code,
            目標月份: `${data.year}年${data.month}月`,
            排班天數: data.schedules.length,
            API回應時間: `${responseTime}ms`
        });
        
    } catch (error) {
        console.error('❌ [DEBUG] 載入選擇員工班表失敗:', error);
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> ${error.message}
            </div>
        `;
    }
}

// 頁面載入時初始化
document.addEventListener('DOMContentLoaded', function() {
    initializeYearOptions();
    loadAvailableMonths();
    loadLightingMembers();
});
</script>
{% endblock %}