{% extends "base.html" %}

{% block title %}ä¸€éµåŒ¯å‡ºæœˆå¤§è¡¨ - ç­è¡¨ç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<h2 class="mb-3">
    <i class="fas fa-download d-md-none"></i>
    ä¸€éµåŒ¯å‡ºæœˆå¤§è¡¨
</h2>

<div class="row">
    <div class="col-lg-8 col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-file-excel"></i> åŒ¯å‡ºè¨­å®š</h5>
            </div>
            <div class="card-body">
                <form id="exportForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="searchQuery" class="form-label">å“¡å·¥å§“åæˆ–å·¥è™Ÿ</label>
                            <input type="text" class="form-control form-control-lg" id="searchQuery" name="query" 
                                   placeholder="è¼¸å…¥å§“åå¦‚ï¼šææƒŸç¶± æˆ–å·¥è™Ÿå¦‚ï¼šEMP_056" required>
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i> æ”¯æ´æ¨¡ç³Šæœå°‹ï¼Œå¦‚è¼¸å…¥ã€Œæã€å¯æ‰¾åˆ°æ‰€æœ‰å§“æçš„å“¡å·¥
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="exportYear" class="form-label">å¹´ä»½</label>
                            <select class="form-select form-select-lg" id="exportYear" name="year" required>
                                <option value="">é¸æ“‡å¹´ä»½</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="exportMonth" class="form-label">æœˆä»½</label>
                            <select class="form-select form-select-lg" id="exportMonth" name="month" required>
                                <option value="">é¸æ“‡æœˆä»½</option>
                                <option value="1">1æœˆ</option>
                                <option value="2">2æœˆ</option>
                                <option value="3">3æœˆ</option>
                                <option value="4">4æœˆ</option>
                                <option value="5">5æœˆ</option>
                                <option value="6">6æœˆ</option>
                                <option value="7">7æœˆ</option>
                                <option value="8">8æœˆ</option>
                                <option value="9">9æœˆ</option>
                                <option value="10">10æœˆ</option>
                                <option value="11">11æœˆ</option>
                                <option value="12">12æœˆ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-info btn-lg me-md-2" onclick="previewSchedule()">
                            <i class="fas fa-eye me-2"></i>é è¦½ç­è¡¨
                        </button>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-download me-2"></i>åŒ¯å‡ºJPGåœ–ç‰‡
                        </button>
                    </div>
                </form>
                
                <div id="exportStatus" class="mt-3"></div>
                
                <!-- ç­è¡¨é è¦½å€åŸŸ -->
                <div id="schedulePreview" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-calendar-alt"></i> ç­è¡¨é è¦½</h5>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-success" onclick="downloadJPG()">
                                    <i class="fas fa-image me-1"></i>ä¸‹è¼‰JPG
                                </button>
                                <button type="button" class="btn btn-primary" onclick="downloadICS()">
                                    <i class="fas fa-calendar-plus me-1"></i>ä¸‹è¼‰ICS
                                </button>
                            </div>
                        </div>
                        <div class="card-body text-center">
                            <div id="calendarPreview" class="calendar-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 col-md-12 mt-3 mt-lg-0">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> ä½¿ç”¨èªªæ˜</h5>
            </div>
            <div class="card-body">
                <h6>æœå°‹æ–¹å¼ï¼š</h6>
                <ul>
                    <li><strong>å§“åæœå°‹ï¼š</strong>è¼¸å…¥å…¨åæˆ–éƒ¨åˆ†å§“å</li>
                    <li><strong>å·¥è™Ÿæœå°‹ï¼š</strong>è¼¸å…¥å“¡å·¥ä»£ç¢¼</li>
                </ul>
                
                <h6 class="mt-3">åŒ¯å‡ºå…§å®¹ï¼š</h6>
                <ul>
                    <li>å®Œæ•´æœˆåº¦æ’ç­è³‡æ–™</li>
                    <li>æ—¥æœŸã€æ˜ŸæœŸã€ç­åˆ¥è³‡è¨Š</li>
                    <li>ä¸Šä¸‹ç­æ™‚é–“</li>
                    <li>Excelæ ¼å¼ï¼Œæ–¹ä¾¿ç·¨è¼¯</li>
                </ul>
                
                <h6 class="mt-3">æª”æ¡ˆæ ¼å¼ï¼š</h6>
                <ul class="small text-muted">
                    <li><strong>JPGåœ–ç‰‡ï¼š</strong>å“¡å·¥å§“å_å¹´æœˆ_ç­è¡¨.jpg</li>
                    <li><strong>ICSæ—¥æ›†ï¼š</strong>å“¡å·¥å§“å_å¹´æœˆ_ç­è¡¨.ics</li>
                </ul>
                <p class="small text-muted">
                    <i class="fas fa-info-circle"></i> ICSæª”æ¡ˆå¯ç›´æ¥åŒ¯å…¥Googleæ—¥æ›†ã€iPhoneæ—¥æ›†ã€Outlookç­‰
                </p>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-lightbulb"></i> ç‡ˆå…‰çµ„å¿«é€Ÿæœå°‹</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2" id="lightingMembersButtons">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ç‡ˆå…‰çµ„äººå“¡ä¸­...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- HTML to Canvas åº« -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
.calendar-container {
    max-width: 400px;
    margin: 0 auto;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    overflow: hidden;
}

.calendar-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    text-align: center;
    font-weight: bold;
    font-size: 18px;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #e5e5e5;
    padding: 1px;
}

.weekday-header {
    background: #f8f9fa;
    padding: 8px 4px;
    text-align: center;
    font-size: 12px;
    font-weight: bold;
    color: #6c757d;
}

.calendar-day {
    background: white;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    position: relative;
}

.calendar-day.empty {
    background: #f8f9fa;
    color: #adb5bd;
}

.day-number {
    font-weight: bold;
    margin-bottom: 2px;
}

.shift-badge {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    margin-top: 2px;
}

/* ç­åˆ¥é¡è‰² */
.shift-fc { background-color: #007bff; }
.shift-p1 { background-color: #28a745; }
.shift-p2 { background-color: #ffc107; color: #000; }
.shift-p3 { background-color: #fd7e14; }
.shift-p4 { background-color: #dc3545; }
.shift-h { background-color: #6c757d; }

.calendar-legend {
    padding: 15px;
    background: #f8f9fa;
    border-top: 1px solid #e5e5e5;
}

.legend-item {
    display: inline-block;
    margin: 2px 8px;
    font-size: 12px;
}

.legend-color {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 2px;
    margin-right: 4px;
    vertical-align: middle;
}
</style>

<script>
// åˆå§‹åŒ–å¹´ä»½é¸é …
function initializeYearOptions() {
    const yearSelect = document.getElementById('exportYear');
    const currentYear = new Date().getFullYear();
    
    // æ·»åŠ ç•¶å‰å¹´ä»½å’Œå‰å¾Œå„2å¹´
    for (let year = currentYear - 2; year <= currentYear + 2; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + 'å¹´';
        if (year === currentYear) {
            option.selected = true;
        }
        yearSelect.appendChild(option);
    }
}

// è¼‰å…¥å¯ç”¨å¹´æœˆè³‡æ–™ä¸¦è¨­å®šé è¨­å€¼
async function loadAvailableMonths() {
    console.log('ğŸ”„ [DEBUG] é–‹å§‹è¼‰å…¥å¯ç”¨æ—¥æœŸç¯„åœ...');
    try {
        const response = await fetch('/api/date_range');
        const dateRange = await response.json();
        
        console.log('ğŸ“Š [DEBUG] æ—¥æœŸç¯„åœè³‡æ–™:', dateRange);
        
        if (dateRange.available_months) {
            const months = Object.values(dateRange.available_months);
            console.log('ğŸ“… [DEBUG] å¯ç”¨æœˆä»½æ•¸é‡:', months.length);
            console.log('ğŸ“… [DEBUG] å¯ç”¨æœˆä»½è©³æƒ…:', months);
            
            if (months.length > 0) {
                document.getElementById('exportYear').value = months[0].year;
                document.getElementById('exportMonth').value = months[0].month;
                console.log('âœ… [DEBUG] é è¨­æ—¥æœŸè¨­å®š:', `${months[0].year}å¹´${months[0].month}æœˆ`);
            }
        }
    } catch (error) {
        console.error('âŒ [DEBUG] è¼‰å…¥æ—¥æœŸç¯„åœå¤±æ•—:', error);
    }
}

// å¿«é€Ÿå¡«å…¥å“¡å·¥å·¥è™Ÿ
function fillEmployee(employeeCode) {
    document.getElementById('searchQuery').value = employeeCode;
    // éš±è—ä¹‹å‰çš„é è¦½çµæœ
    document.getElementById('schedulePreview').style.display = 'none';
    document.getElementById('exportStatus').innerHTML = '';
}

// é è¦½ç­è¡¨
async function previewSchedule() {
    const query = document.getElementById('searchQuery').value.trim();
    const year = document.getElementById('exportYear').value;
    const month = document.getElementById('exportMonth').value;
    
    console.log('ğŸ” [DEBUG] é–‹å§‹é è¦½ç­è¡¨...');
    console.log('ğŸ“ [DEBUG] æœå°‹åƒæ•¸:', { query, year, month });
    
    if (!query || !year || !month) {
        console.error('âŒ [DEBUG] åƒæ•¸ä¸å®Œæ•´:', { query, year, month });
        alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
        return;
    }
    
    const statusDiv = document.getElementById('exportStatus');
    statusDiv.innerHTML = `
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            æ­£åœ¨è¼‰å…¥ç­è¡¨é è¦½...
        </div>
    `;
    
    try {
        // ç²å–å“¡å·¥ç­è¡¨è³‡æ–™
        const params = new URLSearchParams({ query, year, month });
        const apiUrl = `/api/preview_schedule?${params.toString()}`;
        
        console.log('ğŸŒ [DEBUG] APIè«‹æ±‚URL:', apiUrl);
        console.log('ğŸ“¡ [DEBUG] ç™¼é€APIè«‹æ±‚...');
        
        const startTime = performance.now();
        const response = await fetch(apiUrl);
        const endTime = performance.now();
        const responseTime = Math.round(endTime - startTime);
        
        console.log('â±ï¸ [DEBUG] APIå›æ‡‰æ™‚é–“:', `${responseTime}ms`);
        console.log('ğŸ“Š [DEBUG] HTTPç‹€æ…‹ç¢¼:', response.status);
        console.log('ğŸ“Š [DEBUG] Response headers:', Object.fromEntries(response.headers.entries()));
        
        const data = await response.json();
        console.log('ğŸ“Š [DEBUG] APIå›æ‡‰è³‡æ–™:', data);
        
        if (!response.ok) {
            console.error('âŒ [DEBUG] APIå›æ‡‰éŒ¯èª¤:', data);
            throw new Error(data.error || 'è¼‰å…¥å¤±æ•—');
        }
        
        // æª¢æŸ¥æ˜¯å¦è¿”å›å¤šå€‹åŒ¹é…å“¡å·¥
        if (data.multiple_matches) {
            console.log('ğŸ” [DEBUG] æ‰¾åˆ°å¤šå€‹åŒ¹é…å“¡å·¥ï¼Œé¡¯ç¤ºé¸æ“‡åˆ—è¡¨');
            console.log('ğŸ‘¥ [DEBUG] åŒ¹é…å“¡å·¥åˆ—è¡¨:', data.choices);
            showEmployeeChoices(data.choices, year, month, query);
            return;
        }
        
        // åˆ†æå›æ‡‰è³‡æ–™
        console.log('ğŸ‘¤ [DEBUG] æ‰¾åˆ°å“¡å·¥:', data.employee);
        console.log('ğŸ“… [DEBUG] ç›®æ¨™å¹´æœˆ:', `${data.year}å¹´${data.month}æœˆ`);
        console.log('ğŸ“Š [DEBUG] æ’ç­è¨˜éŒ„æ•¸é‡:', data.schedules.length);
        
        if (data.schedules.length > 0) {
            console.log('ğŸ“Š [DEBUG] æ’ç­è¨˜éŒ„ç¯„ä¾‹:', data.schedules.slice(0, 3));
            const shiftTypes = [...new Set(data.schedules.map(s => s.shift_code))];
            console.log('ğŸ¯ [DEBUG] åŒ…å«çš„ç­åˆ¥é¡å‹:', shiftTypes);
        } else {
            console.log('âš ï¸ [DEBUG] è©²æœˆä»½ç„¡æ’ç­è¨˜éŒ„');
        }
        
        console.log('ğŸ“… [DEBUG] æœˆæ›†çµæ§‹:', data.calendar);
        
        // ç”Ÿæˆæœˆæ›†é è¦½
        console.log('ğŸ¨ [DEBUG] é–‹å§‹ç”Ÿæˆæœˆæ›†é è¦½...');
        generateCalendarPreview(data);
        
        // é¡¯ç¤ºé è¦½å€åŸŸ
        document.getElementById('schedulePreview').style.display = 'block';
        statusDiv.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> ç­è¡¨é è¦½å·²ç”Ÿæˆï¼
            </div>
        `;
        
        console.log('âœ… [DEBUG] ç­è¡¨é è¦½ç”Ÿæˆå®Œæˆ');
        console.log('ğŸ“Š [DEBUG] ç¯©é¸çµæœçµ±è¨ˆ:', {
            å“¡å·¥å§“å: data.employee.name,
            å“¡å·¥ä»£ç¢¼: data.employee.employee_code,
            ç›®æ¨™æœˆä»½: `${data.year}å¹´${data.month}æœˆ`,
            æ’ç­å¤©æ•¸: data.schedules.length,
            APIå›æ‡‰æ™‚é–“: `${responseTime}ms`
        });
        
        // æ»¾å‹•åˆ°é è¦½å€åŸŸ
        document.getElementById('schedulePreview').scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        console.error('âŒ [DEBUG] é è¦½å¤±æ•—:', error);
        console.error('âŒ [DEBUG] éŒ¯èª¤è©³æƒ…:', {
            åç¨±: error.name,
            è¨Šæ¯: error.message,
            å †ç–Š: error.stack
        });
        
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> ${error.message}
            </div>
        `;
    }
}

// ç”Ÿæˆæœˆæ›†é è¦½HTML
function generateCalendarPreview(data) {
    const { employee, year, month, schedules, calendar } = data;
    
    const monthNames = ['', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', 
                       '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
    
    const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
    
    // å»ºç«‹ç­è¡¨è³‡æ–™å­—å…¸
    const scheduleMap = {};
    schedules.forEach(schedule => {
        const day = new Date(schedule.date).getDate();
        scheduleMap[day] = schedule;
    });
    
    // ç”Ÿæˆæ¨™é¡Œ
    let html = `
        <div class="calendar-header">
            ${employee.name} å€‹äººç­è¡¨<br>
            <small>å·¥è™Ÿ: ${employee.employee_code} | ${year}å¹´${monthNames[month]}</small>
        </div>
        <div class="calendar-grid">
    `;
    
    // ç”Ÿæˆæ˜ŸæœŸæ¨™é¡Œ
    weekdays.forEach(day => {
        html += `<div class="weekday-header">æ˜ŸæœŸ${day}</div>`;
    });
    
    // ç”Ÿæˆæ—¥æœŸæ ¼å­
    calendar.forEach(week => {
        week.forEach(day => {
            if (day === 0) {
                html += `<div class="calendar-day empty"></div>`;
            } else {
                const schedule = scheduleMap[day];
                const shiftClass = schedule ? getShiftClass(schedule.shift_code) : '';
                
                html += `
                    <div class="calendar-day">
                        <div class="day-number">${day}</div>
                        ${schedule ? `<div class="shift-badge ${shiftClass}">${schedule.shift_code}</div>` : ''}
                    </div>
                `;
            }
        });
    });
    
    html += `</div>`;
    
    // æ·»åŠ åœ–ä¾‹
    const usedShifts = [...new Set(schedules.map(s => s.shift_code))].sort();
    if (usedShifts.length > 0) {
        html += `<div class="calendar-legend">`;
        html += `<strong>ç­åˆ¥èªªæ˜ï¼š</strong><br>`;
        usedShifts.forEach(shift => {
            const shiftClass = getShiftClass(shift);
            const shiftName = schedules.find(s => s.shift_code === shift)?.shift_name || shift;
            html += `
                <div class="legend-item">
                    <span class="legend-color ${shiftClass}"></span>
                    ${shift}: ${shiftName}
                </div>
            `;
        });
        html += `</div>`;
    }
    
    document.getElementById('calendarPreview').innerHTML = html;
}

// å–å¾—ç­åˆ¥CSSé¡åˆ¥
function getShiftClass(shiftCode) {
    if (shiftCode.includes('FC')) return 'shift-fc';
    if (shiftCode.includes('P1')) return 'shift-p1';
    if (shiftCode.includes('P2')) return 'shift-p2';
    if (shiftCode.includes('P3')) return 'shift-p3';
    if (shiftCode.includes('P4')) return 'shift-p4';
    if (shiftCode.includes('H')) return 'shift-h';
    return 'shift-fc'; // é è¨­
}

// ä¸‹è¼‰JPG
async function downloadJPG() {
    console.log('ğŸ“¸ [DEBUG] é–‹å§‹JPGåœ–ç‰‡ä¸‹è¼‰...');
    
    const calendarElement = document.getElementById('calendarPreview');
    
    if (!calendarElement.innerHTML) {
        console.error('âŒ [DEBUG] æ²’æœ‰å¯ä¸‹è¼‰çš„ç­è¡¨é è¦½');
        alert('è«‹å…ˆé è¦½ç­è¡¨');
        return;
    }
    
    try {
        // å–å¾—æª”æ¡ˆè³‡è¨Š
        const query = document.getElementById('searchQuery').value.trim();
        const year = document.getElementById('exportYear').value;
        const month = document.getElementById('exportMonth').value;
        const monthStr = month.toString().padStart(2, '0');
        const fileName = `${query}_${year}å¹´${monthStr}æœˆ_ç­è¡¨.jpg`;
        
        console.log('ğŸ“ [DEBUG] ç›®æ¨™æª”æ¡ˆå:', fileName);
        console.log('ğŸ¨ [DEBUG] é–‹å§‹HTMLè½‰æ›ç‚ºCanvas...');
        
        const startTime = performance.now();
        const canvas = await html2canvas(calendarElement, {
            backgroundColor: '#ffffff',
            scale: 2, // æé«˜è§£æåº¦
            useCORS: true,
            allowTaint: true
        });
        const endTime = performance.now();
        const renderTime = Math.round(endTime - startTime);
        
        console.log('â±ï¸ [DEBUG] Canvasæ¸²æŸ“æ™‚é–“:', `${renderTime}ms`);
        console.log('ğŸ“Š [DEBUG] Canvaså°ºå¯¸:', `${canvas.width}x${canvas.height}`);
        
        // è½‰æ›ç‚ºJPGä¸¦ä¸‹è¼‰
        canvas.toBlob(function(blob) {
            const fileSizeKB = Math.round(blob.size / 1024);
            console.log('ğŸ“Š [DEBUG] JPGæª”æ¡ˆå¤§å°:', `${fileSizeKB}KB`);
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('âœ… [DEBUG] JPGæª”æ¡ˆä¸‹è¼‰å®Œæˆ');
            console.log('ğŸ“Š [DEBUG] JPGåŒ¯å‡ºçµ±è¨ˆ:', {
                æª”æ¡ˆåç¨±: fileName,
                æª”æ¡ˆå¤§å°: `${fileSizeKB}KB`,
                åœ–ç‰‡å°ºå¯¸: `${canvas.width}x${canvas.height}`,
                æ¸²æŸ“æ™‚é–“: `${renderTime}ms`,
                åœ–ç‰‡è³ªé‡: '90%'
            });
            
            document.getElementById('exportStatus').innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> JPGåœ–ç‰‡å·²ä¸‹è¼‰ï¼
                </div>
            `;
        }, 'image/jpeg', 0.9);
        
    } catch (error) {
        console.error('âŒ [DEBUG] JPGä¸‹è¼‰å¤±æ•—:', error);
        console.error('âŒ [DEBUG] éŒ¯èª¤è©³æƒ…:', {
            åç¨±: error.name,
            è¨Šæ¯: error.message,
            å †ç–Š: error.stack
        });
        alert('ä¸‹è¼‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
}

// ä¸‹è¼‰ICSæ—¥æ›†æª”æ¡ˆ
async function downloadICS() {
    console.log('ğŸ“… [DEBUG] é–‹å§‹ICSæ—¥æ›†æª”æ¡ˆä¸‹è¼‰...');
    
    const query = document.getElementById('searchQuery').value.trim();
    const year = document.getElementById('exportYear').value;
    const month = document.getElementById('exportMonth').value;
    
    console.log('ğŸ“ [DEBUG] ICSä¸‹è¼‰åƒæ•¸:', { query, year, month });
    
    if (!query || !year || !month) {
        console.error('âŒ [DEBUG] ICSä¸‹è¼‰åƒæ•¸ä¸å®Œæ•´:', { query, year, month });
        alert('è«‹å…ˆé è¦½ç­è¡¨');
        return;
    }
    
    try {
        const statusDiv = document.getElementById('exportStatus');
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                æ­£åœ¨ç”ŸæˆICSæ—¥æ›†æª”æ¡ˆ...
            </div>
        `;
        
        // å‘¼å«ICSåŒ¯å‡ºAPIï¼Œç¢ºä¿æ­£ç¢ºç·¨ç¢¼
        const params = new URLSearchParams();
        params.append('query', query);
        params.append('year', year);
        params.append('month', month);
        const apiUrl = `/api/export_ics?${params.toString()}`;
        
        console.log('ğŸŒ [DEBUG] ICS APIè«‹æ±‚URL:', apiUrl);
        console.log('ğŸ“¡ [DEBUG] ç™¼é€ICS APIè«‹æ±‚...');
        
        const startTime = performance.now();
        const response = await fetch(apiUrl);
        const endTime = performance.now();
        const responseTime = Math.round(endTime - startTime);
        
        console.log('â±ï¸ [DEBUG] ICS APIå›æ‡‰æ™‚é–“:', `${responseTime}ms`);
        console.log('ğŸ“Š [DEBUG] ICS HTTPç‹€æ…‹ç¢¼:', response.status);
        console.log('ğŸ“Š [DEBUG] ICS Response headers:', Object.fromEntries(response.headers.entries()));
        
        if (!response.ok) {
            const error = await response.json();
            console.error('âŒ [DEBUG] ICS APIå›æ‡‰éŒ¯èª¤:', error);
            throw new Error(error.error || 'ä¸‹è¼‰å¤±æ•—');
        }
        
        // ä¸‹è¼‰æª”æ¡ˆ
        console.log('ğŸ“ [DEBUG] é–‹å§‹è™•ç†ICSæª”æ¡ˆblob...');
        const blob = await response.blob();
        const fileSizeKB = Math.round(blob.size / 1024);
        
        console.log('ğŸ“Š [DEBUG] ICSæª”æ¡ˆå¤§å°:', `${fileSizeKB}KB`);
        console.log('ğŸ“Š [DEBUG] ICSæª”æ¡ˆé¡å‹:', blob.type);
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        const monthStr = month.toString().padStart(2, '0');
        const fileName = `${query}_${year}å¹´${monthStr}æœˆ_ç­è¡¨.ics`;
        
        console.log('ğŸ“ [DEBUG] ICSæª”æ¡ˆåç¨±:', fileName);
        
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        console.log('âœ… [DEBUG] ICSæª”æ¡ˆä¸‹è¼‰å®Œæˆ');
        console.log('ğŸ“Š [DEBUG] ICSåŒ¯å‡ºçµ±è¨ˆ:', {
            æª”æ¡ˆåç¨±: fileName,
            æª”æ¡ˆå¤§å°: `${fileSizeKB}KB`,
            æª”æ¡ˆæ ¼å¼: 'ICS (iCalendar)',
            APIå›æ‡‰æ™‚é–“: `${responseTime}ms`,
            å…§å®¹é¡å‹: blob.type || 'text/calendar'
        });
        
        statusDiv.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> ICSæ—¥æ›†æª”æ¡ˆå·²ä¸‹è¼‰ï¼å¯åŒ¯å…¥åˆ°æ‚¨çš„æ—¥æ›†æ‡‰ç”¨ç¨‹å¼
            </div>
        `;
        
    } catch (error) {
        console.error('âŒ [DEBUG] ICSä¸‹è¼‰å¤±æ•—:', error);
        console.error('âŒ [DEBUG] ICSéŒ¯èª¤è©³æƒ…:', {
            åç¨±: error.name,
            è¨Šæ¯: error.message,
            å †ç–Š: error.stack
        });
        
        document.getElementById('exportStatus').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> ${error.message}
            </div>
        `;
    }
}

// ä¿®æ”¹åŸæœ¬çš„è¡¨å–®æäº¤è™•ç†ï¼ˆç¾åœ¨ä¹Ÿæ”¯æ´é è¦½ï¼‰
document.getElementById('exportForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    previewSchedule(); // ç›´æ¥å‘¼å«é è¦½åŠŸèƒ½
});

// è¼‰å…¥ç‡ˆå…‰çµ„äººå“¡åˆ—è¡¨
async function loadLightingMembers() {
    console.log('ğŸ‘¥ [DEBUG] é–‹å§‹è¼‰å…¥ç‡ˆå…‰çµ„äººå“¡åˆ—è¡¨...');
    try {
        const response = await fetch('/api/group-members');
        const result = await response.json();
        
        console.log('ğŸ“Š [DEBUG] ç¾¤çµ„äººå“¡APIå›æ‡‰:', result);
        
        if (result.status === 'success' && result.data.ç‡ˆå…‰çµ„) {
            const members = result.data.ç‡ˆå…‰çµ„;
            console.log('ğŸ‘¥ [DEBUG] ç‡ˆå…‰çµ„äººå“¡æ•¸é‡:', members.length);
            console.log('ğŸ‘¥ [DEBUG] ç‡ˆå…‰çµ„äººå“¡åå–®:', members);
            
            const buttonsContainer = document.getElementById('lightingMembersButtons');
            
            if (members.length === 0) {
                console.log('âš ï¸  [DEBUG] ç‡ˆå…‰çµ„äººå“¡åå–®ç‚ºç©º');
                buttonsContainer.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle"></i> å°šæœªè¨­å®šç‡ˆå…‰çµ„äººå“¡åå–®
                    </div>
                `;
            } else {
                // ç”Ÿæˆäººå“¡æŒ‰éˆ•
                const colors = ['primary', 'secondary', 'info', 'success', 'warning', 'danger'];
                const buttons = members.map((member, index) => {
                    const colorClass = colors[index % colors.length];
                    return `
                        <button class="btn btn-outline-${colorClass} btn-sm" onclick="fillEmployee('${member}')">
                            ${member}
                        </button>
                    `;
                }).join('');
                
                console.log('ğŸ¨ [DEBUG] ç”ŸæˆæŒ‰éˆ•HTMLå®Œæˆ');
                buttonsContainer.innerHTML = buttons;
            }
            
        } else if (result.message === 'éœ€è¦ç™»å…¥') {
            console.log('ğŸ” [DEBUG] ç”¨æˆ¶æœªç™»å…¥');
            // ç”¨æˆ¶æœªç™»å…¥ï¼Œé¡¯ç¤ºæç¤º
            document.getElementById('lightingMembersButtons').innerHTML = `
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle"></i> è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹ç‡ˆå…‰çµ„äººå“¡åå–®
                </div>
            `;
            return;
        } else {
            throw new Error(result.message || 'è¼‰å…¥å¤±æ•—');
        }
    } catch (error) {
        console.error('âŒ [DEBUG] è¼‰å…¥ç‡ˆå…‰çµ„äººå“¡å¤±æ•—:', error);
        document.getElementById('lightingMembersButtons').innerHTML = `
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle"></i> ${error.message || 'è¼‰å…¥äººå“¡åå–®å¤±æ•—'}
            </div>
        `;
        document.getElementById('memberCount').textContent = 'è¼‰å…¥å¤±æ•—';
    }
}

// é¡¯ç¤ºå“¡å·¥é¸æ“‡åˆ—è¡¨
function showEmployeeChoices(choices, year, month, originalQuery) {
    console.log('ğŸ‘¥ [DEBUG] é–‹å§‹ç”Ÿæˆå“¡å·¥é¸æ“‡ç•Œé¢');
    console.log('ğŸ“ [DEBUG] é¸æ“‡åƒæ•¸:', { choices, year, month, originalQuery });
    
    const statusDiv = document.getElementById('exportStatus');
    
    // ç”Ÿæˆé¸æ“‡æŒ‰éˆ•
    const choiceButtons = choices.map((employee, index) => {
        const colorClasses = ['primary', 'success', 'info', 'warning', 'danger', 'secondary'];
        const colorClass = colorClasses[index % colorClasses.length];
        
        return `
            <button class="btn btn-outline-${colorClass} btn-lg me-2 mb-2" 
                    onclick="selectEmployee('${employee.id}', '${year}', '${month}', '${employee.name}', '${employee.employee_code}')">
                <i class="fas fa-user me-2"></i>
                <strong>${employee.name}</strong>
                <br>
                <small class="text-muted">${employee.employee_code}</small>
            </button>
        `;
    }).join('');
    
    statusDiv.innerHTML = `
        <div class="alert alert-warning">
            <h5><i class="fas fa-users me-2"></i>æ‰¾åˆ°å¤šå€‹å“¡å·¥åŒ¹é…ã€Œ${originalQuery}ã€</h5>
            <p class="mb-3">è«‹é¸æ“‡è¦æŸ¥çœ‹ç­è¡¨çš„å“¡å·¥ï¼š</p>
            <div class="d-flex flex-wrap">
                ${choiceButtons}
            </div>
            <hr>
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                æç¤ºï¼šæ‚¨ä¹Ÿå¯ä»¥è¼¸å…¥æ›´å®Œæ•´çš„å§“åæˆ–å·¥è™Ÿä¾†ç›´æ¥å®šä½ç‰¹å®šå“¡å·¥
            </small>
        </div>
    `;
    
    // éš±è—ä¹‹å‰çš„é è¦½çµæœ
    document.getElementById('schedulePreview').style.display = 'none';
    
    console.log('âœ… [DEBUG] å“¡å·¥é¸æ“‡ç•Œé¢ç”Ÿæˆå®Œæˆ');
}

// è™•ç†å“¡å·¥é¸æ“‡
async function selectEmployee(employeeId, year, month, employeeName, employeeCode) {
    console.log('ğŸ¯ [DEBUG] ç”¨æˆ¶é¸æ“‡å“¡å·¥:', { employeeId, year, month, employeeName, employeeCode });
    
    const statusDiv = document.getElementById('exportStatus');
    statusDiv.innerHTML = `
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            æ­£åœ¨è¼‰å…¥ ${employeeName} (${employeeCode}) çš„ç­è¡¨...
        </div>
    `;
    
    try {
        // æ›´æ–°æœå°‹æ¡†å…§å®¹
        document.getElementById('searchQuery').value = employeeName;
        
        // å‘¼å«æ–°çš„APIç«¯é»
        const params = new URLSearchParams({ employee_id: employeeId, year, month });
        const apiUrl = `/api/preview_schedule_by_id?${params.toString()}`;
        
        console.log('ğŸŒ [DEBUG] é¸æ“‡å“¡å·¥APIè«‹æ±‚URL:', apiUrl);
        console.log('ğŸ“¡ [DEBUG] ç™¼é€é¸æ“‡å“¡å·¥APIè«‹æ±‚...');
        
        const startTime = performance.now();
        const response = await fetch(apiUrl);
        const endTime = performance.now();
        const responseTime = Math.round(endTime - startTime);
        
        console.log('â±ï¸ [DEBUG] é¸æ“‡å“¡å·¥APIå›æ‡‰æ™‚é–“:', `${responseTime}ms`);
        console.log('ğŸ“Š [DEBUG] é¸æ“‡å“¡å·¥HTTPç‹€æ…‹ç¢¼:', response.status);
        
        const data = await response.json();
        console.log('ğŸ“Š [DEBUG] é¸æ“‡å“¡å·¥APIå›æ‡‰è³‡æ–™:', data);
        
        if (!response.ok) {
            console.error('âŒ [DEBUG] é¸æ“‡å“¡å·¥APIå›æ‡‰éŒ¯èª¤:', data);
            throw new Error(data.error || 'è¼‰å…¥å¤±æ•—');
        }
        
        // åˆ†æå›æ‡‰è³‡æ–™
        console.log('ğŸ‘¤ [DEBUG] é¸æ“‡çš„å“¡å·¥è³‡æ–™:', data.employee);
        console.log('ğŸ“… [DEBUG] é¸æ“‡çš„ç›®æ¨™å¹´æœˆ:', `${data.year}å¹´${data.month}æœˆ`);
        console.log('ğŸ“Š [DEBUG] é¸æ“‡çš„æ’ç­è¨˜éŒ„æ•¸é‡:', data.schedules.length);
        
        if (data.schedules.length > 0) {
            console.log('ğŸ“Š [DEBUG] é¸æ“‡çš„æ’ç­è¨˜éŒ„ç¯„ä¾‹:', data.schedules.slice(0, 3));
            const shiftTypes = [...new Set(data.schedules.map(s => s.shift_code))];
            console.log('ğŸ¯ [DEBUG] é¸æ“‡çš„åŒ…å«ç­åˆ¥é¡å‹:', shiftTypes);
        } else {
            console.log('âš ï¸ [DEBUG] è©²å“¡å·¥è©²æœˆä»½ç„¡æ’ç­è¨˜éŒ„');
        }
        
        // ç”Ÿæˆæœˆæ›†é è¦½
        console.log('ğŸ¨ [DEBUG] é–‹å§‹ç”Ÿæˆé¸æ“‡å“¡å·¥çš„æœˆæ›†é è¦½...');
        generateCalendarPreview(data);
        
        // é¡¯ç¤ºé è¦½å€åŸŸ
        document.getElementById('schedulePreview').style.display = 'block';
        statusDiv.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> 
                å·²è¼‰å…¥ <strong>${employeeName}</strong> (${employeeCode}) çš„ç­è¡¨é è¦½ï¼
            </div>
        `;
        
        console.log('âœ… [DEBUG] é¸æ“‡å“¡å·¥çš„ç­è¡¨é è¦½ç”Ÿæˆå®Œæˆ');
        console.log('ğŸ“Š [DEBUG] é¸æ“‡å“¡å·¥çš„ç¯©é¸çµæœçµ±è¨ˆ:', {
            å“¡å·¥å§“å: data.employee.name,
            å“¡å·¥ä»£ç¢¼: data.employee.employee_code,
            ç›®æ¨™æœˆä»½: `${data.year}å¹´${data.month}æœˆ`,
            æ’ç­å¤©æ•¸: data.schedules.length,
            APIå›æ‡‰æ™‚é–“: `${responseTime}ms`
        });
        
    } catch (error) {
        console.error('âŒ [DEBUG] è¼‰å…¥é¸æ“‡å“¡å·¥ç­è¡¨å¤±æ•—:', error);
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> ${error.message}
            </div>
        `;
    }
}

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initializeYearOptions();
    loadAvailableMonths();
    loadLightingMembers();
});
</script>
{% endblock %}