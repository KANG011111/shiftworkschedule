{% extends "base.html" %}

{% block title %}ç­è¡¨åŒ¯å…¥é©—è­‰ç³»çµ± v1.2 - ç­è¡¨ç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<h2 class="mb-4">
    <i class="fas fa-upload"></i>
    ç­è¡¨åŒ¯å…¥é©—è­‰ç³»çµ± v1.2
    <small class="text-muted">ï¼ˆé™ç³»çµ±ç®¡ç†å“¡ä½¿ç”¨ï¼‰</small>
</h2>

<!-- åŒ¯å…¥ç‹€æ…‹é¡¯ç¤º -->
{% if success %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle"></i> {{ success }}
    <div class="mt-2">
        <a href="{{ url_for('main.index') }}" class="btn btn-success btn-sm">
            <i class="fas fa-home me-1"></i>æŸ¥çœ‹é¦–é æœ€æ–°æ’ç­
        </a>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if error %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-triangle"></i> {{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<div class="row">
    <div class="col-lg-8">
        <!-- ä¸Šå‚³å€åŸŸ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-file-upload"></i> 1. ä¸Šå‚³ Excel æª”æ¡ˆ</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" method="post" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="file" class="form-label">é¸æ“‡æª”æ¡ˆ</label>
                            <input type="file" class="form-control" id="file" name="file" 
                                   accept=".csv" required>
                            <div class="form-text">
                                <i class="fas fa-file-csv text-info"></i> åªæ”¯æ´ CSV æ ¼å¼æª”æ¡ˆ
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">è³‡æ–™ç‰ˆæœ¬</label>
                            <div class="form-control-plaintext bg-light rounded p-2">
                                <i class="fas fa-check text-success"></i> 
                                <span id="detectedVersion" class="fw-bold text-success">ä¸€èˆ¬ç‰ˆæœ¬</span>
                            </div>
                            <small class="form-text text-muted">
                                çµ±ä¸€ä½¿ç”¨ä¸€èˆ¬ç‰ˆæœ¬æ ¼å¼
                            </small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="target_group" class="form-label">åŒ¯å…¥äººå“¡ç¾¤çµ„</label>
                            <select class="form-select" id="target_group" name="target_group" required>
                                <option value="">è«‹é¸æ“‡åŒ¯å…¥ç¾¤çµ„</option>
                                <option value="ç‡ˆå…‰çµ„">ğŸ’¡ ç‡ˆå…‰çµ„</option>
                                <option value="å…¨åå–®" selected>å…¨åå–®ï¼ˆä¸éæ¿¾ï¼‰</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="uploadBtn">
                            <span id="uploadBtnText">
                                <i class="fas fa-upload"></i> ä¸Šå‚³ä¸¦é©—è­‰
                            </span>
                            <span id="uploadBtnSpinner" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> è™•ç†ä¸­...
                            </span>
                        </button>
                    </div>
                    
                    <!-- é€²åº¦æç¤ºå€åŸŸ -->
                    <div id="progressArea" style="display: none;" class="mt-3">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <span id="progressText">æ­£åœ¨è™•ç†CSVæ–‡ä»¶ï¼Œè«‹ç¨å€™...</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" id="progressBar">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- é è¦½å€åŸŸ -->
        {% if preview_data %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-eye"></i> 2. é è¦½ç­è¡¨ï¼ˆç‡ˆå…‰çµ„æ ¸å¿ƒäººå“¡ï¼‰</h5>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-secondary" onclick="filterTable('all')" id="filterAll">å…¨éƒ¨</button>
                    <button class="btn btn-sm btn-outline-warning" onclick="filterTable('warning')" id="filterWarning">åªçœ‹è­¦å‘Š</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="filterTable('error')" id="filterError">åªçœ‹éŒ¯èª¤</button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-bordered table-sm table-hover" id="previewTable">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th style="width: 80px; cursor: pointer;" onclick="sortTable(0)">
                                    è¡Œè™Ÿ <i class="fas fa-sort"></i>
                                </th>
                                <th style="width: 120px; cursor: pointer;" onclick="sortTable(1)">
                                    å§“å <i class="fas fa-sort"></i>
                                </th>
                                {% if preview_data and preview_data[0].employee_code is defined and preview_data[0].employee_code %}
                                <th style="width: 100px; cursor: pointer;" onclick="sortTable(2)">
                                    å“¡å·¥ä»£ç¢¼ <i class="fas fa-sort"></i>
                                </th>
                                {% endif %}
                                <th style="width: 120px; cursor: pointer;" onclick="sortTable({% if preview_data and preview_data[0].employee_code is defined and preview_data[0].employee_code %}3{% else %}2{% endif %})">
                                    æ—¥æœŸ <i class="fas fa-sort"></i>
                                </th>
                                <th style="width: 100px; cursor: pointer;" onclick="sortTable({% if preview_data and preview_data[0].employee_code is defined and preview_data[0].employee_code %}4{% else %}3{% endif %})">
                                    ç­åˆ¥ <i class="fas fa-sort"></i>
                                </th>
                                <th style="width: 120px; cursor: pointer;" onclick="sortTable({% if preview_data and preview_data[0].employee_code is defined and preview_data[0].employee_code %}5{% else %}4{% endif %})">
                                    é©—è­‰çµæœ <i class="fas fa-sort"></i>
                                </th>
                                <th>å•é¡Œèªªæ˜</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                            {% for row in preview_data %}
                            <tr class="{% if row.status == 'error' %}bg-danger-subtle{% elif row.status == 'warning' %}bg-warning-subtle{% else %}bg-success-subtle{% endif %}" 
                                data-status="{{ row.status }}">
                                <td>{{ row.row }}</td>
                                <td>{% if row.name %}{{ row.name }}{% else %}<span class="text-muted">ï¼ˆç©ºç™½ï¼‰</span>{% endif %}</td>
                                {% if row.employee_code is defined and row.employee_code %}
                                <td>
                                    <code class="bg-light">{{ row.employee_code }}</code>
                                </td>
                                {% endif %}
                                <td>{{ row.date }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ row.shift }}</span>
                                </td>
                                <td>
                                    {% if row.status == 'error' %}
                                        <span class="text-danger fw-bold">âŒ éŒ¯èª¤</span>
                                    {% elif row.status == 'warning' %}
                                        <span class="text-warning fw-bold">âš ï¸ è­¦å‘Š</span>
                                    {% else %}
                                        <span class="text-success">âœ… é€šé</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if row.message %}
                                        {% if row.status == 'error' %}
                                            <span class="text-danger fw-bold">{{ row.message }}</span>
                                        {% elif row.status == 'warning' %}
                                            <span class="text-warning fw-bold">{{ row.message }}</span>
                                        {% else %}
                                            {{ row.message }}
                                        {% endif %}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- åº•éƒ¨çµ±è¨ˆ -->
                {% if validation_result %}
                <div class="mt-3 p-3 bg-light rounded">
                    <div class="text-center">
                        <strong>
                            âœ… {{ validation_result.valid_records }} ç­†é€šéï¼Œ
                            âš ï¸ {{ validation_result.warnings }} ç­†è­¦å‘Šï¼Œ
                            âŒ {{ validation_result.errors }} ç­†éŒ¯èª¤
                        </strong>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- é©—è­‰çµæœå€åŸŸ -->
        {% if validation_result %}
        <div class="card mb-4">
            <div class="card-header">
                <h5>
                    <i class="fas fa-check-circle"></i> 3. é©—è­‰çµæœ
                    {% if validation_result.status == 'OK' %}
                        <span class="badge bg-success ms-2">é€šé</span>
                    {% elif validation_result.status == 'WARNING' %}
                        <span class="badge bg-warning ms-2">è­¦å‘Š</span>
                    {% else %}
                        <span class="badge bg-danger ms-2">éŒ¯èª¤</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <!-- çµ±è¨ˆè³‡è¨Š -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-primary">{{ validation_result.total_records }}</h4>
                            <small class="text-muted">ç¸½è¨˜éŒ„æ•¸</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-success">{{ validation_result.valid_records }}</h4>
                            <small class="text-muted">æœ‰æ•ˆè¨˜éŒ„</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-warning">{{ validation_result.warnings }}</h4>
                            <small class="text-muted">è­¦å‘Šæ•¸é‡</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-danger">{{ validation_result.errors }}</h4>
                            <small class="text-muted">éŒ¯èª¤æ•¸é‡</small>
                        </div>
                    </div>
                </div>

                <!-- ç‡ˆå…‰çµ„æ ¸å¿ƒäººå“¡ç­æ•¸çµ±è¨ˆ -->
                {% if validation_result.core_light_crew_stats %}
                <div class="card mt-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-users"></i> ç‡ˆå…‰çµ„æ ¸å¿ƒäººå“¡ç­æ•¸çµ±è¨ˆ
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for name, count in validation_result.core_light_crew_stats.items() %}
                            <div class="col-md-4 col-sm-6 mb-2">
                                <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                                    <span class="fw-bold">{{ name }}</span>
                                    <span class="badge bg-primary">{{ count }}ç­</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- ç­æ•¸å¹³è¡¡æª¢æŸ¥ -->
                        {% set shift_counts = validation_result.core_light_crew_stats.values() | list %}
                        {% set unique_counts = shift_counts | unique | list %}
                        
                        {% if unique_counts | length == 1 %}
                        <div class="alert alert-success mt-2 mb-0">
                            <i class="fas fa-check-circle"></i> 
                            <strong>ç­æ•¸å¹³è¡¡ï¼š</strong>æ‰€æœ‰æ ¸å¿ƒäººå“¡éƒ½æœ‰ {{ unique_counts[0] }} ç­ï¼Œæ’ç­å¹³è¡¡ï¼
                        </div>
                        {% else %}
                        <div class="alert alert-warning mt-2 mb-0">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <strong>ç­æ•¸ä¸å¹³è¡¡ï¼š</strong>æ ¸å¿ƒäººå“¡ç­æ•¸ä¸ä¸€è‡´ï¼Œæœ€å°‘ {{ shift_counts | min }}ç­ï¼Œæœ€å¤š {{ shift_counts | max }}ç­
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- å…¨é«”ç­æ•¸ç›¸ç­‰é©—è­‰ -->
                {% if validation_result.shift_equality %}
                <div class="card mt-3">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-balance-scale"></i> ç­æ•¸åˆ†å¸ƒé©—è­‰
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-transparent">
                                        <h6 class="mb-0">çµ±è¨ˆè³‡æ–™</h6>
                                    </div>
                                    <div class="card-body">
                                        {% if validation_result.shift_equality.statistics %}
                                        <table class="table table-sm table-borderless mb-0">
                                            <tr>
                                                <td>ç¸½äººæ•¸ï¼š</td>
                                                <td><strong>{{ validation_result.shift_equality.statistics.total_people }}</strong> äºº</td>
                                            </tr>
                                            <tr>
                                                <td>å¹³å‡ç­æ•¸ï¼š</td>
                                                <td><strong>{{ validation_result.shift_equality.statistics.avg_shifts }}</strong> ç­</td>
                                            </tr>
                                            <tr>
                                                <td>æœ€å¤šç­æ•¸ï¼š</td>
                                                <td><strong>{{ validation_result.shift_equality.statistics.max_shifts }}</strong> ç­</td>
                                            </tr>
                                            <tr>
                                                <td>æœ€å°‘ç­æ•¸ï¼š</td>
                                                <td><strong>{{ validation_result.shift_equality.statistics.min_shifts }}</strong> ç­</td>
                                            </tr>
                                            <tr>
                                                <td>ç­æ•¸å·®ç•°ï¼š</td>
                                                <td>
                                                    <strong class="{% if validation_result.shift_equality.statistics.shift_difference <= 2 %}text-success{% else %}text-danger{% endif %}">
                                                        {{ validation_result.shift_equality.statistics.shift_difference }}
                                                    </strong> ç­
                                                </td>
                                            </tr>
                                        </table>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-transparent">
                                        <h6 class="mb-0">é©—è­‰çµæœ</h6>
                                    </div>
                                    <div class="card-body">
                                        {% if validation_result.shift_equality.is_valid %}
                                        <div class="alert alert-success mb-2">
                                            <i class="fas fa-check-circle"></i> 
                                            <strong>ç­æ•¸åˆ†å¸ƒå‡å‹»</strong>
                                        </div>
                                        {% else %}
                                        <div class="alert alert-danger mb-2">
                                            <i class="fas fa-times-circle"></i> 
                                            <strong>ç­æ•¸åˆ†å¸ƒä¸å‡</strong>
                                        </div>
                                        {% endif %}
                                        
                                        {% if validation_result.shift_equality.uneven_distribution %}
                                        <div class="mt-2">
                                            <small class="text-muted">ç­æ•¸ç•°å¸¸äººå“¡ï¼š</small>
                                            <ul class="list-unstyled mb-0 mt-1">
                                                {% for person in validation_result.shift_equality.uneven_distribution %}
                                                <li class="small">
                                                    <strong>{{ person.name }}</strong>: 
                                                    {{ person.actual_shifts }}ç­ 
                                                    <span class="{% if person.difference > 0 %}text-success{% else %}text-warning{% endif %}">
                                                        ({{ '+' if person.difference > 0 else '' }}{{ person.difference }})
                                                    </span>
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                        
                                        {% if validation_result.shift_equality.duplicate_records %}
                                        <div class="mt-2">
                                            <small class="text-danger">é‡è¤‡è¨˜éŒ„ï¼š</small>
                                            <ul class="list-unstyled mb-0 mt-1">
                                                {% for dup in validation_result.shift_equality.duplicate_records %}
                                                <li class="small text-danger">
                                                    <strong>{{ dup.name }}</strong> åœ¨ {{ dup.date }} é‡è¤‡ {{ dup.count }} æ¬¡ç­åˆ¥ {{ dup.shift }} (ç¬¬{{ dup.line }}è¡Œ)
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                        
                                        {% if validation_result.shift_equality.part_time_employees %}
                                        <div class="mt-2">
                                            <small class="text-info">éå…¨è·äººå“¡ï¼š</small>
                                            <div class="small text-muted">
                                                {{ validation_result.shift_equality.part_time_employees | join(', ') }}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- éŒ¯èª¤è¨Šæ¯ -->
                {% if validation_result.error_messages %}
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle"></i> ç™¼ç¾ä»¥ä¸‹å•é¡Œï¼š</h6>
                    <ul class="mb-0">
                        {% for message in validation_result.error_messages %}
                        <li>{{ message }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- åŒ¯å…¥é¸é …å’ŒæŒ‰éˆ• -->
                <form method="post" action="{{ url_for('main.confirm_import') }}">
                    <input type="hidden" name="csv_data" value="{{ validation_result.csv_data | e }}">
                    <input type="hidden" name="target_group" value="{{ validation_result.target_group }}">
                    <input type="hidden" name="filename" value="{{ validation_result.filename }}">
                    
                    <!-- åŒ¯å…¥æ¨¡å¼é¸æ“‡ -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">ğŸ“‹ åŒ¯å…¥æ¨¡å¼é¸æ“‡</h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="import_mode" 
                                               value="merge" id="merge-mode" checked>
                                        <label class="form-check-label" for="merge-mode">
                                            <strong>ğŸ”„ åˆä½µæ¨¡å¼</strong> (å»ºè­°)
                                            <small class="text-muted d-block">ä¿ç•™ç¾æœ‰è³‡æ–™ï¼Œæ–°å¢æˆ–æ›´æ–°æ’ç­è¨˜éŒ„</small>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="import_mode" 
                                               value="overwrite" id="overwrite-mode">
                                        <label class="form-check-label" for="overwrite-mode">
                                            <strong>ğŸ—‘ï¸ è¦†è“‹æ¨¡å¼</strong>
                                            <small class="text-muted d-block">æ¸…é™¤ç¾æœ‰è³‡æ–™å¾Œé‡æ–°åŒ¯å…¥</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">âš™ï¸ é€²éšé¸é …</h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" name="force_import" 
                                               value="true" id="force-import">
                                        <label class="form-check-label" for="force-import">
                                            <strong>ğŸ”§ å¼·åˆ¶åŒ¯å…¥æ¨¡å¼</strong>
                                            <small class="text-muted d-block">å¿½ç•¥ç­åˆ¥é©—è­‰ï¼Œè‡ªå‹•å»ºç«‹æ–°ç­åˆ¥</small>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="allow_blank_shifts" 
                                               value="true" id="allow-blank-shifts" checked>
                                        <label class="form-check-label" for="allow-blank-shifts">
                                            <strong>ğŸ“ å…è¨±ç©ºç™½ç­åˆ¥</strong>
                                            <small class="text-muted d-block">å°‡ç©ºç™½ç­åˆ¥è™•ç†ç‚ºæœªæ’ç­</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åŒ¯å…¥è³‡è¨Šæ‘˜è¦ -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">ğŸ“Š æ‰¹é‡åŒ¯å…¥è³‡è¨Š</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <p class="mb-1"><strong>ç¸½è¨˜éŒ„æ•¸ï¼š</strong>{{ validation_result.total_records }} ç­†</p>
                                        </div>
                                        <div class="col-md-3">
                                            <p class="mb-1"><strong>æœ‰æ•ˆè¨˜éŒ„ï¼š</strong>{{ validation_result.valid_records }} ç­†</p>
                                        </div>
                                        <div class="col-md-3">
                                            <p class="mb-1"><strong>è­¦å‘Šæ•¸é‡ï¼š</strong>{{ validation_result.warnings }} ç­†</p>
                                        </div>
                                        <div class="col-md-3">
                                            <p class="mb-1"><strong>éŒ¯èª¤æ•¸é‡ï¼š</strong>{{ validation_result.errors }} ç­†</p>
                                        </div>
                                    </div>
                                    <p class="mb-0"><strong>é è¨ˆè™•ç†æ™‚é–“ï¼š</strong>ç´„ {{ (validation_result.total_records / 100) | round(1) }} ç§’</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        {% if validation_result.status == 'OK' %}
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-rocket"></i> ğŸš€ é–‹å§‹æ‰¹é‡åŒ¯å…¥ ({{ validation_result.total_records }} ç­†)
                            </button>
                        {% else %}
                            <button type="submit" name="force_import" value="true" 
                                    class="btn btn-warning btn-lg"
                                    onclick="return confirm('è³‡æ–™æœ‰å•é¡Œä½†ä»è¦å¼·åˆ¶åŒ¯å…¥ï¼Ÿ')">
                                <i class="fas fa-exclamation-triangle"></i> âš ï¸ æˆ‘å·²ç¢ºèªä»è¦å¼·åˆ¶åŒ¯å…¥
                            </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-lg-4">
        <!-- è¦ç¯„èªªæ˜ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-file-csv text-info"></i> CSV æ ¼å¼è¦ç¯„</h5>
            </div>
            <div class="card-body">
                <h6>æª”æ¡ˆæ ¼å¼ï¼š</h6>
                <div class="alert alert-info">
                    <i class="fas fa-file-csv"></i> <strong>åƒ…æ”¯æ´ CSV æ ¼å¼ï¼ˆ.csvï¼‰</strong><br>
                    <small>ç³»çµ±æœƒè‡ªå‹•åµæ¸¬æª”æ¡ˆç·¨ç¢¼ï¼ˆUTF-8ã€Big5ã€GBKç­‰ï¼‰</small>
                </div>

                <h6>æ”¯æ´æ ¼å¼ï¼š</h6>
                <div class="alert alert-info mb-3">
                    <strong>ğŸ“‹ 3æ¬„ä½æ ¼å¼ï¼ˆæ¨™æº–ï¼‰ï¼š</strong>
                    <ul class="mb-0 mt-2">
                        <li><i class="fas fa-check text-success"></i> <strong>å§“å</strong>ï¼ˆæˆ–å“¡å·¥å§“åï¼‰</li>
                        <li><i class="fas fa-check text-success"></i> <strong>æ—¥æœŸ</strong>ï¼ˆå®Œæ•´æ—¥æœŸï¼Œå¦‚ 2024-07-01ï¼‰</li>
                        <li><i class="fas fa-check text-success"></i> <strong>ç­åˆ¥</strong>ï¼ˆæˆ–ç­æ¬¡ï¼‰</li>
                    </ul>
                </div>
                <div class="alert alert-warning mb-3">
                    <strong>ğŸ†• 5æ¬„ä½æ ¼å¼ï¼ˆé€²éšï¼‰ï¼š</strong>
                    <ul class="mb-0 mt-2">
                        <li><i class="fas fa-check text-success"></i> <strong>å§“å</strong>ï¼ˆæˆ–å“¡å·¥å§“åï¼‰</li>
                        <li><i class="fas fa-check text-success"></i> <strong>å“¡å·¥ä»£ç¢¼</strong>ï¼ˆæˆ–ä»£ç¢¼ï¼‰</li>
                        <li><i class="fas fa-check text-success"></i> <strong>å¹´æœˆ</strong>ï¼ˆå¦‚ 2024-10ï¼‰</li>
                        <li><i class="fas fa-check text-success"></i> <strong>æ—¥æœŸ</strong>ï¼ˆæ—¥æ•¸ï¼Œå¦‚ 8ï¼‰</li>
                        <li><i class="fas fa-check text-success"></i> <strong>ç­åˆ¥</strong>ï¼ˆæˆ–ç­æ¬¡ï¼‰</li>
                    </ul>
                </div>

                <h6 class="mt-3">æ”¯æ´ç­åˆ¥ï¼š</h6>
                <div class="row">
                    <div class="col-4">
                        <span class="badge" style="background-color: #28a745">P1s</span><br>
                        <span class="badge" style="background-color: #28a745">P1sa</span><br>
                        <span class="badge" style="background-color: #20c997">P1c</span><br>
                        <span class="badge" style="background-color: #20c997">P1n</span><br>
                        <span class="badge" style="background-color: #17a2b8">P1p</span><br>
                        <span class="badge" style="background-color: #ffc107; color: #000">P2s</span><br>
                        <span class="badge" style="background-color: #ffc107; color: #000">P2sa</span>
                    </div>
                    <div class="col-4">
                        <span class="badge" style="background-color: #fd7e14">P2c</span><br>
                        <span class="badge" style="background-color: #fd7e14">P2n</span><br>
                        <span class="badge" style="background-color: #e83e8c">P2p</span><br>
                        <span class="badge" style="background-color: #dc3545">P3c</span><br>
                        <span class="badge" style="background-color: #dc3545">P3n</span><br>
                        <span class="badge" style="background-color: #6f42c1">P3p</span><br>
                        <span class="badge" style="background-color: #495057">P4c</span>
                    </div>
                    <div class="col-4">
                        <span class="badge" style="background-color: #495057">P4n</span><br>
                        <span class="badge" style="background-color: #343a40">P4p</span><br>
                        <span class="badge" style="background-color: #6c757d">H0</span><br>
                        <span class="badge" style="background-color: #6c757d">H1</span><br>
                        <span class="badge" style="background-color: #6c757d">H2</span>
                    </div>
                </div>

                <h6 class="mt-3">æ—¥æœŸæ ¼å¼ï¼š</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success"></i> 2024-07-01</li>
                    <li><i class="fas fa-check text-success"></i> 2024/07/01</li>
                </ul>

                <h6 class="mt-3">CSV ç¯„ä¾‹ï¼š</h6>
                <div class="mb-3">
                    <strong>ğŸ“‹ 3æ¬„ä½æ ¼å¼ç¯„ä¾‹ï¼š</strong>
                    <div class="bg-light p-2 rounded">
                        <code>
                            å§“å,æ—¥æœŸ,ç­åˆ¥<br>
                            è³´ç§‰å®,2024-07-01,P1s<br>
                            ææƒŸç¶±,2024-07-01,P2c<br>
                            æå®¶ç‘‹,2024-07-01,P3n
                        </code>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>ğŸ†• 5æ¬„ä½æ ¼å¼ç¯„ä¾‹ï¼š</strong>
                    <div class="bg-light p-2 rounded">
                        <code>
                            å§“å,å“¡å·¥ä»£ç¢¼,å¹´æœˆ,æ—¥æœŸ,ç­åˆ¥<br>
                            è³´ç§‰å®,8652,2024-10,8,FC<br>
                            ææƒŸç¶±,8312,2024-10,8,FX<br>
                            æå®¶ç‘‹,8512,2024-10,9,P1s
                        </code>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç•¶å‰ç­è¡¨ç‹€æ…‹ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-database"></i> ç•¶å‰ç­è¡¨ç‹€æ…‹</h5>
            </div>
            <div class="card-body">
                {% if current_stats %}
                <div class="row">
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="text-center">
                            <h4 class="text-primary mb-1">{{ current_stats.total_schedules }}</h4>
                            <small class="text-muted">ç¸½æ’ç­è¨˜éŒ„</small>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="text-center">
                            <h4 class="text-success mb-1">{{ current_stats.total_employees }}</h4>
                            <small class="text-muted">ç¸½å“¡å·¥æ•¸</small>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="text-center">
                            {% if current_stats.today_schedules > 0 %}
                                <h4 class="text-warning mb-1">{{ current_stats.today_schedules }}</h4>
                                <small class="text-muted">ä»Šæ—¥æ’ç­</small>
                            {% else %}
                                <h4 class="text-muted mb-1">0</h4>
                                <small class="text-muted">ä»Šæ—¥ç„¡æ’ç­</small>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="text-center">
                            <h4 class="text-info mb-1">{{ current_stats.month_schedules }}</h4>
                            <small class="text-muted">æœ¬æœˆæ’ç­</small>
                        </div>
                    </div>
                </div>
                
                {% if current_stats.earliest_date and current_stats.latest_date %}
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>
                            <strong>è³‡æ–™ç¯„åœï¼š</strong>
                            {{ current_stats.earliest_date.strftime('%Yå¹´%mæœˆ%dæ—¥') }} 
                            è‡³ 
                            {{ current_stats.latest_date.strftime('%Yå¹´%mæœˆ%dæ—¥') }}
                            {% if current_stats.latest_date < current_stats.today %}
                                <span class="text-warning ms-2">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    è³‡æ–™å¯èƒ½éœ€è¦æ›´æ–°
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    ç›®å‰è³‡æ–™åº«ä¸­æ²’æœ‰ç­è¡¨è³‡æ–™ï¼Œè«‹å…ˆåŒ¯å…¥ç­è¡¨æª”æ¡ˆã€‚
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- åŒ¯å…¥æ­·å² -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> æœ€è¿‘åŒ¯å…¥è¨˜éŒ„</h5>
            </div>
            <div class="card-body">
                {% if recent_imports %}
                    {% for log in recent_imports %}
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <small class="fw-bold">{{ log.filename }}</small>
                            {% if log.validation_result == 'OK' %}
                                <span class="badge bg-success">OK</span>
                            {% elif log.validation_result == 'WARNING' %}
                                <span class="badge bg-warning">WARNING</span>
                            {% else %}
                                <span class="badge bg-danger">ERROR</span>
                            {% endif %}
                        </div>
                        <small class="text-muted">
                            {{ log.importer }} | {{ log.import_time.strftime('%m-%d %H:%M') }} | 
                            {{ log.target_group }} | {{ log.records_imported }}ç­†è¨˜éŒ„
                        </small>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">æš«ç„¡åŒ¯å…¥è¨˜éŒ„</p>
                {% endif %}
            </div>
        </div>
        
        <!-- è³‡æ–™ç®¡ç† -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-database"></i> è³‡æ–™ç®¡ç†</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>å±éšªæ“ä½œ</strong><br>
                    <small>æ¸…é™¤æ‰€æœ‰ç­è¡¨è³‡æ–™å¾Œç„¡æ³•å¾©åŸï¼Œè«‹è¬¹æ…æ“ä½œ</small>
                </div>
                
                <div class="d-grid">
                    <button type="button" class="btn btn-danger" onclick="confirmClearAllData()">
                        <i class="fas fa-trash-alt me-2"></i>æ¸…é™¤æ‰€æœ‰ç­è¡¨è³‡æ–™
                    </button>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        æ­¤æ“ä½œå°‡æ¸…é™¤ï¼šæ’ç­è¨˜éŒ„ã€åŒ¯å…¥æ—¥èªŒï¼ˆä¿ç•™å“¡å·¥å’Œç­åˆ¥è¨­å®šï¼‰
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç¾¤çµ„ç®¡ç†å€åŸŸ -->
<div class="group-management-section mt-5">
    <div class="row">
        <div class="col-12">
            <h4 class="mb-4">
                <i class="fas fa-users"></i> ç¾¤çµ„äººå“¡ç®¡ç†
                <small class="text-muted">ç®¡ç†å„ç¾¤çµ„çš„äººå“¡åå–®</small>
            </h4>
        </div>
    </div>
    
    <div class="row justify-content-center">
        <!-- ç‡ˆå…‰çµ„ -->
        <div class="col-md-8 col-lg-6 mb-3">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">ğŸ’¡ ç‡ˆå…‰çµ„äººå“¡åå–®</h6>
                </div>
                <div class="card-body">
                    <textarea class="form-control" id="lighting-members" rows="12" 
                              placeholder="è¼¸å…¥ç‡ˆå…‰çµ„äººå“¡å§“åï¼Œä¸€è¡Œä¸€å€‹&#10;ä¾‹å¦‚ï¼š&#10;å¼µä¸‰&#10;æå››&#10;ç‹äº”"
                              oninput="updateMemberCount('lighting')"></textarea>
                    <small class="text-muted mt-2 d-block">
                        ç›®å‰äººæ•¸: <span id="lighting-count" class="fw-bold text-warning">0</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç‡ˆå…‰çµ„æ“ä½œæŒ‰éˆ• -->
    <div class="text-center mt-4">
        <button class="btn btn-primary btn-lg" onclick="saveGroupSettings()">
            <i class="fas fa-save"></i> å„²å­˜ç‡ˆå…‰çµ„äººå“¡åå–®
        </button>
        <button class="btn btn-secondary btn-lg ms-2" onclick="loadGroupSettings()">
            <i class="fas fa-download"></i> é‡æ–°è¼‰å…¥åå–®
        </button>
        <button class="btn btn-info btn-lg ms-2" onclick="addDefaultMembers()">
            <i class="fas fa-users-plus"></i> åŠ å…¥é è¨­äººå“¡
        </button>
        <button class="btn btn-warning btn-lg ms-2" onclick="clearAllGroups()">
            <i class="fas fa-trash"></i> æ¸…ç©ºåå–®
        </button>
    </div>
    
    <!-- æˆåŠŸè¨Šæ¯é¡¯ç¤ºå€åŸŸ -->
    <div class="row mt-3">
        <div class="col-12">
            <div id="groupMessage" class="alert" style="display: none;"></div>
        </div>
    </div>
</div>

<script>
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    const uploadBtn = document.getElementById('uploadBtn');
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è™•ç†ä¸­...';
    uploadBtn.disabled = true;
});

// æª”æ¡ˆé¸æ“‡å¾Œé¡¯ç¤ºç‰ˆæœ¬
document.getElementById('file').addEventListener('change', function(e) {
    const fileName = e.target.files[0]?.name || '';
    const detectedVersionSpan = document.getElementById('detectedVersion');
    
    if (fileName) {
        // çµ±ä¸€ä½¿ç”¨ä¸€èˆ¬ç‰ˆæœ¬
        detectedVersionSpan.textContent = 'ä¸€èˆ¬ç‰ˆæœ¬';
        detectedVersionSpan.className = 'fw-bold text-success';
        
        // æ·»åŠ çŸ­æš«çš„é–ƒçˆæ•ˆæœ
        detectedVersionSpan.style.backgroundColor = '#d4edda';
        setTimeout(() => {
            detectedVersionSpan.style.backgroundColor = '';
        }, 1000);
    } else {
        detectedVersionSpan.textContent = 'ä¸€èˆ¬ç‰ˆæœ¬';
        detectedVersionSpan.className = 'fw-bold text-info';
    }
});

function toggleShowAll() {
    const toggleText = document.getElementById('toggleText');
    const tableBody = document.getElementById('previewTableBody');
    
    if (toggleText.textContent === 'æŸ¥çœ‹å…¨éƒ¨') {
        // é€™è£¡å¯ä»¥é€šéAJAXåŠ è¼‰æ›´å¤šæ•¸æ“š
        toggleText.textContent = 'æ”¶åˆ';
        // æš«æ™‚åªæ˜¯ä¿®æ”¹æ–‡å­—ï¼Œå¯¦éš›å¯¦ç¾éœ€è¦å¾Œç«¯æ”¯æ´
    } else {
        toggleText.textContent = 'æŸ¥çœ‹å…¨éƒ¨';
    }
}

function filterTable(status) {
    const table = document.getElementById('previewTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    // é‡ç½®æŒ‰éˆ•æ¨£å¼
    document.getElementById('filterAll').className = 'btn btn-sm btn-outline-secondary';
    document.getElementById('filterWarning').className = 'btn btn-sm btn-outline-warning';
    document.getElementById('filterError').className = 'btn btn-sm btn-outline-danger';
    
    // è¨­ç½®ç•¶å‰æŒ‰éˆ•ç‚ºé¸ä¸­ç‹€æ…‹
    if (status === 'all') {
        document.getElementById('filterAll').className = 'btn btn-sm btn-secondary';
    } else if (status === 'warning') {
        document.getElementById('filterWarning').className = 'btn btn-sm btn-warning';
    } else if (status === 'error') {
        document.getElementById('filterError').className = 'btn btn-sm btn-danger';
    }
    
    // éæ¿¾è¡Œ
    for (let i = 0; i < rows.length; i++) {
        const rowStatus = rows[i].getAttribute('data-status');
        if (status === 'all' || rowStatus === status) {
            rows[i].style.display = '';
        } else {
            rows[i].style.display = 'none';
        }
    }
}

function sortTable(columnIndex) {
    const table = document.getElementById('previewTable');
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    // ç²å–æ’åºæ–¹å‘
    const currentSort = table.getAttribute('data-sort-column');
    const currentDirection = table.getAttribute('data-sort-direction') || 'asc';
    const newDirection = (currentSort == columnIndex && currentDirection === 'asc') ? 'desc' : 'asc';
    
    // æ’åºè¡Œ
    rows.sort((a, b) => {
        const aText = a.cells[columnIndex].textContent.trim();
        const bText = b.cells[columnIndex].textContent.trim();
        
        // æ•¸å­—æ¯”è¼ƒï¼ˆå°è¡Œè™Ÿæ¬„ä½ï¼‰
        if (columnIndex === 0) {
            const aNum = parseInt(aText) || 0;
            const bNum = parseInt(bText) || 0;
            return newDirection === 'asc' ? aNum - bNum : bNum - aNum;
        }
        
        // æ–‡å­—æ¯”è¼ƒ
        const comparison = aText.localeCompare(bText, 'zh-TW');
        return newDirection === 'asc' ? comparison : -comparison;
    });
    
    // é‡æ–°æ’å…¥æ’åºå¾Œçš„è¡Œ
    rows.forEach(row => tbody.appendChild(row));
    
    // æ›´æ–°æ’åºç‹€æ…‹
    table.setAttribute('data-sort-column', columnIndex);
    table.setAttribute('data-sort-direction', newDirection);
    
    // æ›´æ–°æ’åºåœ–æ¨™
    const headers = table.getElementsByTagName('th');
    for (let i = 0; i < headers.length; i++) {
        const icon = headers[i].querySelector('i');
        if (icon) {
            if (i === columnIndex) {
                icon.className = newDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            } else {
                icon.className = 'fas fa-sort';
            }
        }
    }
}

// ä¸Šå‚³é€²åº¦è™•ç†
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    // é¡¯ç¤ºé€²åº¦æç¤º
    document.getElementById('uploadBtnText').style.display = 'none';
    document.getElementById('uploadBtnSpinner').style.display = 'inline';
    document.getElementById('uploadBtn').disabled = true;
    document.getElementById('progressArea').style.display = 'block';
    
    // æ¨¡æ“¬é€²åº¦æ›´æ–°
    let progress = 0;
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        
        progressBar.style.width = progress + '%';
        
        if (progress < 30) {
            progressText.textContent = 'æ­£åœ¨è®€å–CSVæ–‡ä»¶...';
        } else if (progress < 60) {
            progressText.textContent = 'æ­£åœ¨é©—è­‰æ•¸æ“šæ ¼å¼...';
        } else if (progress < 90) {
            progressText.textContent = 'æ­£åœ¨åˆ†æç­è¡¨æ•¸æ“š...';
        }
    }, 300);
    
    // è¡¨å–®æäº¤å®Œæˆå¾Œæ¸…ç†
    setTimeout(() => {
        clearInterval(interval);
    }, 10000);
});

// ç‡ˆå…‰çµ„ç®¡ç†åŠŸèƒ½
const groupIds = ['lighting'];
const groupNames = {
    'lighting': 'ç‡ˆå…‰çµ„'
};

// è‡ªå‹•è¨ˆç®—äººæ•¸
function updateMemberCount(groupId) {
    const textarea = document.getElementById(groupId + '-members');
    const countSpan = document.getElementById(groupId + '-count');
    const names = textarea.value.trim().split('\n').filter(name => name.trim());
    countSpan.textContent = names.length;
}

// è¼‰å…¥ç¾¤çµ„è¨­å®š
async function loadGroupSettings() {
    try {
        const response = await fetch('/api/group-members');
        const result = await response.json();
        
        if (result.status === 'success') {
            const data = result.data;
            
            groupIds.forEach(groupId => {
                const groupName = groupNames[groupId];
                const textarea = document.getElementById(groupId + '-members');
                const members = data[groupName] || [];
                textarea.value = members.join('\n');
                updateMemberCount(groupId);
            });
            
            showGroupMessage('âœ… å·²è¼‰å…¥æœ€æ–°çš„ç‡ˆå…‰çµ„äººå“¡åå–®', 'success');
        } else {
            showGroupMessage('âŒ è¼‰å…¥äººå“¡åå–®å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('è¼‰å…¥ç¾¤çµ„è¨­å®šéŒ¯èª¤:', error);
        showGroupMessage('âŒ è¼‰å…¥äººå“¡åå–®å¤±æ•—', 'danger');
    }
}

// åŠ å…¥é è¨­ç‡ˆå…‰çµ„äººå“¡
function addDefaultMembers() {
    const defaultMembers = [
        'è³´ç§‰å®',
        'ææƒŸç¶±', 
        'æå®¶ç‘‹',
        'ç‹å¿—å¿ ',
        'é¡§è‚²ç¦',
        'èƒ¡ç¿Šæ½”',
        'æœ±å®¶å¾·'
    ];
    
    const textarea = document.getElementById('lighting-members');
    const currentMembers = textarea.value.trim().split('\n').filter(name => name.trim());
    
    // åˆä½µç¾æœ‰äººå“¡å’Œé è¨­äººå“¡ï¼Œå»é‡
    const allMembers = [...new Set([...currentMembers, ...defaultMembers])].filter(name => name.trim());
    
    textarea.value = allMembers.join('\n');
    updateMemberCount('lighting');
    
    showGroupMessage(`âœ… å·²åŠ å…¥é è¨­äººå“¡ï¼Œç›®å‰å…± ${allMembers.length} ä½ç‡ˆå…‰çµ„æˆå“¡`, 'info');
}

// é¡¯ç¤ºç¾¤çµ„æ“ä½œè¨Šæ¯
function showGroupMessage(message, type) {
    const messageDiv = document.getElementById('groupMessage');
    messageDiv.className = `alert alert-${type}`;
    messageDiv.innerHTML = message;
    messageDiv.style.display = 'block';
    
    // 3ç§’å¾Œè‡ªå‹•éš±è—
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 3000);
}

// å„²å­˜ç¾¤çµ„è¨­å®š
async function saveGroupSettings() {
    try {
        const groupData = {};
        
        groupIds.forEach(groupId => {
            const groupName = groupNames[groupId];
            const textarea = document.getElementById(groupId + '-members');
            const names = textarea.value.trim().split('\n')
                           .map(name => name.trim())
                           .filter(name => name);
            groupData[groupName] = names;
        });
        
        const response = await fetch('/api/group-members', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(groupData)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('âœ… ç¾¤çµ„è¨­å®šå·²å„²å­˜ï¼');
            // é‡æ–°è¼‰å…¥ä»¥ç¢ºèªå„²å­˜æˆåŠŸ
            await loadGroupSettings();
        } else {
            alert('âŒ å„²å­˜å¤±æ•—: ' + result.message);
        }
    } catch (error) {
        console.error('å„²å­˜ç¾¤çµ„è¨­å®šéŒ¯èª¤:', error);
        alert('âŒ å„²å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
}

// æ¸…ç©ºç‡ˆå…‰çµ„åå–®
function clearAllGroups() {
    if (confirm('ç¢ºå®šè¦æ¸…ç©ºç‡ˆå…‰çµ„äººå“¡åå–®å—ï¼Ÿ')) {
        groupIds.forEach(groupId => {
            const textarea = document.getElementById(groupId + '-members');
            textarea.value = '';
            updateMemberCount(groupId);
        });
        alert('å·²æ¸…ç©ºç‡ˆå…‰çµ„äººå“¡åå–®');
    }
}

// ç¢ºèªæ¸…é™¤æ‰€æœ‰è³‡æ–™
async function confirmClearAllData() {
    // é›™é‡ç¢ºèªå°è©±æ¡†
    const firstConfirm = confirm('âš ï¸ å±éšªæ“ä½œï¼\n\né€™å°‡æœƒæ¸…é™¤æ‰€æœ‰ç­è¡¨è³‡æ–™å’ŒåŒ¯å…¥è¨˜éŒ„ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ');
    
    if (!firstConfirm) {
        return;
    }
    
    const secondConfirm = confirm('ğŸ”¥ æœ€çµ‚ç¢ºèªï¼\n\næ‚¨å³å°‡æ¸…é™¤ï¼š\nâ€¢ æ‰€æœ‰æ’ç­è¨˜éŒ„\nâ€¢ æ‰€æœ‰åŒ¯å…¥æ—¥èªŒ\nâ€¢ å“¡å·¥å’Œç­åˆ¥è¨­å®šå°‡ä¿ç•™\n\nè«‹å†æ¬¡ç¢ºèªæ˜¯å¦è¦åŸ·è¡Œï¼Ÿ');
    
    if (!secondConfirm) {
        return;
    }
    
    try {
        // é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
        const clearButton = document.querySelector('button[onclick="confirmClearAllData()"]');
        const originalHTML = clearButton.innerHTML;
        clearButton.disabled = true;
        clearButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>æ¸…é™¤ä¸­...';
        
        // ç™¼é€æ¸…é™¤è«‹æ±‚
        const response = await fetch('/api/clear-all-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('âœ… è³‡æ–™æ¸…é™¤å®Œæˆï¼\n\n' + result.message);
            // åˆ·æ–°é é¢ä»¥æ›´æ–°çµ±è¨ˆæ•¸æ“š
            window.location.reload();
        } else {
            alert('âŒ æ¸…é™¤å¤±æ•—ï¼š' + result.message);
            // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
            clearButton.disabled = false;
            clearButton.innerHTML = originalHTML;
        }
    } catch (error) {
        console.error('æ¸…é™¤è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        alert('âŒ æ¸…é™¤éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        const clearButton = document.querySelector('button[onclick="confirmClearAllData()"]');
        clearButton.disabled = false;
        clearButton.innerHTML = '<i class="fas fa-trash-alt me-2"></i>æ¸…é™¤æ‰€æœ‰ç­è¡¨è³‡æ–™';
    }
}

// åˆå§‹åŒ–ï¼šé è¨­é¡¯ç¤ºå…¨éƒ¨ä¸¦è¼‰å…¥ç¾¤çµ„è¨­å®š
window.onload = function() {
    if (document.getElementById('filterAll')) {
        filterTable('all');
    }
    
    // è¼‰å…¥ç¾¤çµ„è¨­å®š
    loadGroupSettings();
};
</script>
{% endblock %}