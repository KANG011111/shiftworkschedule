{% extends "base.html" %}

{% block title %}班表匯入驗證系統 v1.2 - 班表管理系統{% endblock %}

{% block content %}
<h2 class="mb-4">
    <i class="fas fa-upload"></i>
    班表匯入驗證系統 v1.2
    <small class="text-muted">（限系統管理員使用）</small>
</h2>

<!-- 匯入狀態顯示 -->
{% if success %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle"></i> {{ success }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if error %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-triangle"></i> {{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<div class="row">
    <div class="col-lg-8">
        <!-- 上傳區域 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-file-upload"></i> 1. 上傳 Excel 檔案</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" method="post" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="file" class="form-label">選擇檔案</label>
                            <input type="file" class="form-control" id="file" name="file" 
                                   accept=".csv" required>
                            <div class="form-text">
                                <i class="fas fa-file-csv text-info"></i> 只支援 CSV 格式檔案
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">資料版本</label>
                            <div class="form-control-plaintext bg-light rounded p-2">
                                <i class="fas fa-check text-success"></i> 
                                <span id="detectedVersion" class="fw-bold text-success">一般版本</span>
                            </div>
                            <small class="form-text text-muted">
                                統一使用一般版本格式
                            </small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="target_group" class="form-label">匯入人員群組</label>
                            <select class="form-select" id="target_group" name="target_group" required>
                                <option value="">請選擇人員群組</option>
                                <option value="統籌組">📊 統籌組</option>
                                <option value="燈光組">💡 燈光組</option>
                                <option value="舞台組">🎭 舞台組</option>
                                <option value="視聽組">🔊 視聽組</option>
                                <option value="維護組">🔧 維護組</option>
                                <option value="演出人員">演出人員 (統籌+舞台)</option>
                                <option value="技術人員">技術人員 (燈光+視聽+維護)</option>
                                <option value="全名單">全名單（不過濾）</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="skip_invalid" name="skip_invalid">
                                <label class="form-check-label" for="skip_invalid">
                                    略過不在白名單者並繼續匯入
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="uploadBtn">
                            <span id="uploadBtnText">
                                <i class="fas fa-upload"></i> 上傳並驗證
                            </span>
                            <span id="uploadBtnSpinner" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> 處理中...
                            </span>
                        </button>
                    </div>
                    
                    <!-- 進度提示區域 -->
                    <div id="progressArea" style="display: none;" class="mt-3">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <span id="progressText">正在處理CSV文件，請稍候...</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" id="progressBar">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 預覽區域 -->
        {% if preview_data %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-eye"></i> 2. 預覽班表（燈光組核心人員）</h5>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-secondary" onclick="filterTable('all')" id="filterAll">全部</button>
                    <button class="btn btn-sm btn-outline-warning" onclick="filterTable('warning')" id="filterWarning">只看警告</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="filterTable('error')" id="filterError">只看錯誤</button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-bordered table-sm table-hover" id="previewTable">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th style="width: 80px; cursor: pointer;" onclick="sortTable(0)">
                                    行號 <i class="fas fa-sort"></i>
                                </th>
                                <th style="width: 120px; cursor: pointer;" onclick="sortTable(1)">
                                    姓名 <i class="fas fa-sort"></i>
                                </th>
                                {% if preview_data and preview_data[0].employee_code is defined and preview_data[0].employee_code %}
                                <th style="width: 100px; cursor: pointer;" onclick="sortTable(2)">
                                    員工代碼 <i class="fas fa-sort"></i>
                                </th>
                                {% endif %}
                                <th style="width: 120px; cursor: pointer;" onclick="sortTable({% if preview_data and preview_data[0].employee_code is defined and preview_data[0].employee_code %}3{% else %}2{% endif %})">
                                    日期 <i class="fas fa-sort"></i>
                                </th>
                                <th style="width: 100px; cursor: pointer;" onclick="sortTable({% if preview_data and preview_data[0].employee_code is defined and preview_data[0].employee_code %}4{% else %}3{% endif %})">
                                    班別 <i class="fas fa-sort"></i>
                                </th>
                                <th style="width: 120px; cursor: pointer;" onclick="sortTable({% if preview_data and preview_data[0].employee_code is defined and preview_data[0].employee_code %}5{% else %}4{% endif %})">
                                    驗證結果 <i class="fas fa-sort"></i>
                                </th>
                                <th>問題說明</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                            {% for row in preview_data %}
                            <tr class="{% if row.status == 'error' %}bg-danger-subtle{% elif row.status == 'warning' %}bg-warning-subtle{% else %}bg-success-subtle{% endif %}" 
                                data-status="{{ row.status }}">
                                <td>{{ row.row }}</td>
                                <td>{% if row.name %}{{ row.name }}{% else %}<span class="text-muted">（空白）</span>{% endif %}</td>
                                {% if row.employee_code is defined and row.employee_code %}
                                <td>
                                    <code class="bg-light">{{ row.employee_code }}</code>
                                </td>
                                {% endif %}
                                <td>{{ row.date }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ row.shift }}</span>
                                </td>
                                <td>
                                    {% if row.status == 'error' %}
                                        <span class="text-danger fw-bold">❌ 錯誤</span>
                                    {% elif row.status == 'warning' %}
                                        <span class="text-warning fw-bold">⚠️ 警告</span>
                                    {% else %}
                                        <span class="text-success">✅ 通過</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if row.message %}
                                        {% if row.status == 'error' %}
                                            <span class="text-danger fw-bold">{{ row.message }}</span>
                                        {% elif row.status == 'warning' %}
                                            <span class="text-warning fw-bold">{{ row.message }}</span>
                                        {% else %}
                                            {{ row.message }}
                                        {% endif %}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- 底部統計 -->
                {% if validation_result %}
                <div class="mt-3 p-3 bg-light rounded">
                    <div class="text-center">
                        <strong>
                            ✅ {{ validation_result.valid_records }} 筆通過，
                            ⚠️ {{ validation_result.warnings }} 筆警告，
                            ❌ {{ validation_result.errors }} 筆錯誤
                        </strong>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- 驗證結果區域 -->
        {% if validation_result %}
        <div class="card mb-4">
            <div class="card-header">
                <h5>
                    <i class="fas fa-check-circle"></i> 3. 驗證結果
                    {% if validation_result.status == 'OK' %}
                        <span class="badge bg-success ms-2">通過</span>
                    {% elif validation_result.status == 'WARNING' %}
                        <span class="badge bg-warning ms-2">警告</span>
                    {% else %}
                        <span class="badge bg-danger ms-2">錯誤</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <!-- 統計資訊 -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-primary">{{ validation_result.total_records }}</h4>
                            <small class="text-muted">總記錄數</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-success">{{ validation_result.valid_records }}</h4>
                            <small class="text-muted">有效記錄</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-warning">{{ validation_result.warnings }}</h4>
                            <small class="text-muted">警告數量</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-danger">{{ validation_result.errors }}</h4>
                            <small class="text-muted">錯誤數量</small>
                        </div>
                    </div>
                </div>

                <!-- 燈光組核心人員班數統計 -->
                {% if validation_result.core_light_crew_stats %}
                <div class="card mt-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-users"></i> 燈光組核心人員班數統計
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for name, count in validation_result.core_light_crew_stats.items() %}
                            <div class="col-md-4 col-sm-6 mb-2">
                                <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                                    <span class="fw-bold">{{ name }}</span>
                                    <span class="badge bg-primary">{{ count }}班</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- 班數平衡檢查 -->
                        {% set shift_counts = validation_result.core_light_crew_stats.values() | list %}
                        {% set unique_counts = shift_counts | unique | list %}
                        
                        {% if unique_counts | length == 1 %}
                        <div class="alert alert-success mt-2 mb-0">
                            <i class="fas fa-check-circle"></i> 
                            <strong>班數平衡：</strong>所有核心人員都有 {{ unique_counts[0] }} 班，排班平衡！
                        </div>
                        {% else %}
                        <div class="alert alert-warning mt-2 mb-0">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <strong>班數不平衡：</strong>核心人員班數不一致，最少 {{ shift_counts | min }}班，最多 {{ shift_counts | max }}班
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- 全體班數相等驗證 -->
                {% if validation_result.shift_equality %}
                <div class="card mt-3">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-balance-scale"></i> 班數分布驗證
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-transparent">
                                        <h6 class="mb-0">統計資料</h6>
                                    </div>
                                    <div class="card-body">
                                        {% if validation_result.shift_equality.statistics %}
                                        <table class="table table-sm table-borderless mb-0">
                                            <tr>
                                                <td>總人數：</td>
                                                <td><strong>{{ validation_result.shift_equality.statistics.total_people }}</strong> 人</td>
                                            </tr>
                                            <tr>
                                                <td>平均班數：</td>
                                                <td><strong>{{ validation_result.shift_equality.statistics.avg_shifts }}</strong> 班</td>
                                            </tr>
                                            <tr>
                                                <td>最多班數：</td>
                                                <td><strong>{{ validation_result.shift_equality.statistics.max_shifts }}</strong> 班</td>
                                            </tr>
                                            <tr>
                                                <td>最少班數：</td>
                                                <td><strong>{{ validation_result.shift_equality.statistics.min_shifts }}</strong> 班</td>
                                            </tr>
                                            <tr>
                                                <td>班數差異：</td>
                                                <td>
                                                    <strong class="{% if validation_result.shift_equality.statistics.shift_difference <= 2 %}text-success{% else %}text-danger{% endif %}">
                                                        {{ validation_result.shift_equality.statistics.shift_difference }}
                                                    </strong> 班
                                                </td>
                                            </tr>
                                        </table>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-transparent">
                                        <h6 class="mb-0">驗證結果</h6>
                                    </div>
                                    <div class="card-body">
                                        {% if validation_result.shift_equality.is_valid %}
                                        <div class="alert alert-success mb-2">
                                            <i class="fas fa-check-circle"></i> 
                                            <strong>班數分布均勻</strong>
                                        </div>
                                        {% else %}
                                        <div class="alert alert-danger mb-2">
                                            <i class="fas fa-times-circle"></i> 
                                            <strong>班數分布不均</strong>
                                        </div>
                                        {% endif %}
                                        
                                        {% if validation_result.shift_equality.uneven_distribution %}
                                        <div class="mt-2">
                                            <small class="text-muted">班數異常人員：</small>
                                            <ul class="list-unstyled mb-0 mt-1">
                                                {% for person in validation_result.shift_equality.uneven_distribution %}
                                                <li class="small">
                                                    <strong>{{ person.name }}</strong>: 
                                                    {{ person.actual_shifts }}班 
                                                    <span class="{% if person.difference > 0 %}text-success{% else %}text-warning{% endif %}">
                                                        ({{ '+' if person.difference > 0 else '' }}{{ person.difference }})
                                                    </span>
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- 錯誤訊息 -->
                {% if validation_result.error_messages %}
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle"></i> 發現以下問題：</h6>
                    <ul class="mb-0">
                        {% for message in validation_result.error_messages %}
                        <li>{{ message }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- 匯入選項和按鈕 -->
                <form method="post" action="{{ url_for('main.confirm_import') }}">
                    <input type="hidden" name="csv_data" value="{{ validation_result.csv_data | e }}">
                    <input type="hidden" name="target_group" value="{{ validation_result.target_group }}">
                    <input type="hidden" name="filename" value="{{ validation_result.filename }}">
                    
                    <!-- 匯入模式選擇 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">📋 匯入模式選擇</h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="import_mode" 
                                               value="merge" id="merge-mode" checked>
                                        <label class="form-check-label" for="merge-mode">
                                            <strong>🔄 合併模式</strong> (建議)
                                            <small class="text-muted d-block">保留現有資料，新增或更新排班記錄</small>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="import_mode" 
                                               value="overwrite" id="overwrite-mode">
                                        <label class="form-check-label" for="overwrite-mode">
                                            <strong>🗑️ 覆蓋模式</strong>
                                            <small class="text-muted d-block">清除現有資料後重新匯入</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">📊 批量匯入資訊</h6>
                                </div>
                                <div class="card-body">
                                    <p class="mb-1"><strong>總記錄數：</strong>{{ validation_result.total_records }} 筆</p>
                                    <p class="mb-1"><strong>有效記錄：</strong>{{ validation_result.valid_records }} 筆</p>
                                    <p class="mb-0"><strong>預計處理時間：</strong>約 {{ (validation_result.total_records / 100) | round(1) }} 秒</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        {% if validation_result.status == 'OK' %}
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-rocket"></i> 🚀 開始批量匯入 ({{ validation_result.total_records }} 筆)
                            </button>
                        {% else %}
                            <button type="submit" name="force_import" value="true" 
                                    class="btn btn-warning btn-lg"
                                    onclick="return confirm('資料有問題但仍要強制匯入？')">
                                <i class="fas fa-exclamation-triangle"></i> ⚠️ 我已確認仍要強制匯入
                            </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-lg-4">
        <!-- 規範說明 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-file-csv text-info"></i> CSV 格式規範</h5>
            </div>
            <div class="card-body">
                <h6>檔案格式：</h6>
                <div class="alert alert-info">
                    <i class="fas fa-file-csv"></i> <strong>僅支援 CSV 格式（.csv）</strong><br>
                    <small>系統會自動偵測檔案編碼（UTF-8、Big5、GBK等）</small>
                </div>

                <h6>支援格式：</h6>
                <div class="alert alert-info mb-3">
                    <strong>📋 3欄位格式（標準）：</strong>
                    <ul class="mb-0 mt-2">
                        <li><i class="fas fa-check text-success"></i> <strong>姓名</strong>（或員工姓名）</li>
                        <li><i class="fas fa-check text-success"></i> <strong>日期</strong>（完整日期，如 2024-07-01）</li>
                        <li><i class="fas fa-check text-success"></i> <strong>班別</strong>（或班次）</li>
                    </ul>
                </div>
                <div class="alert alert-warning mb-3">
                    <strong>🆕 5欄位格式（進階）：</strong>
                    <ul class="mb-0 mt-2">
                        <li><i class="fas fa-check text-success"></i> <strong>姓名</strong>（或員工姓名）</li>
                        <li><i class="fas fa-check text-success"></i> <strong>員工代碼</strong>（或代碼）</li>
                        <li><i class="fas fa-check text-success"></i> <strong>年月</strong>（如 2024-10）</li>
                        <li><i class="fas fa-check text-success"></i> <strong>日期</strong>（日數，如 8）</li>
                        <li><i class="fas fa-check text-success"></i> <strong>班別</strong>（或班次）</li>
                    </ul>
                </div>

                <h6 class="mt-3">支援班別：</h6>
                <div class="row">
                    <div class="col-6">
                        <span class="badge bg-primary">A</span> 早班<br>
                        <span class="badge bg-warning">B</span> 中班<br>
                    </div>
                    <div class="col-6">
                        <span class="badge bg-danger">C</span> 晚班<br>
                        <span class="badge bg-secondary">OFF</span> 休假<br>
                    </div>
                </div>

                <h6 class="mt-3">日期格式：</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success"></i> 2024-07-01</li>
                    <li><i class="fas fa-check text-success"></i> 2024/07/01</li>
                </ul>

                <h6 class="mt-3">CSV 範例：</h6>
                <div class="mb-3">
                    <strong>📋 3欄位格式範例：</strong>
                    <div class="bg-light p-2 rounded">
                        <code>
                            姓名,日期,班別<br>
                            賴秉宏,2024-07-01,A<br>
                            李惟綱,2024-07-01,B<br>
                            李家瑋,2024-07-01,C
                        </code>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>🆕 5欄位格式範例：</strong>
                    <div class="bg-light p-2 rounded">
                        <code>
                            姓名,員工代碼,年月,日期,班別<br>
                            賴秉宏,8652,2024-10,8,FC<br>
                            李惟綱,8312,2024-10,8,FX<br>
                            李家瑋,8512,2024-10,9,P1s
                        </code>
                    </div>
                </div>
            </div>
        </div>

        <!-- 匯入歷史 -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> 最近匯入記錄</h5>
            </div>
            <div class="card-body">
                {% if recent_imports %}
                    {% for log in recent_imports %}
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <small class="fw-bold">{{ log.filename }}</small>
                            {% if log.validation_result == 'OK' %}
                                <span class="badge bg-success">OK</span>
                            {% elif log.validation_result == 'WARNING' %}
                                <span class="badge bg-warning">WARNING</span>
                            {% else %}
                                <span class="badge bg-danger">ERROR</span>
                            {% endif %}
                        </div>
                        <small class="text-muted">
                            {{ log.importer }} | {{ log.import_time.strftime('%m-%d %H:%M') }} | 
                            {{ log.target_group }} | {{ log.records_imported }}筆記錄
                        </small>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">暫無匯入記錄</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 群組管理區域 -->
<div class="group-management-section mt-5">
    <div class="row">
        <div class="col-12">
            <h4 class="mb-4">
                <i class="fas fa-users"></i> 群組人員管理
                <small class="text-muted">管理各群組的人員名單</small>
            </h4>
        </div>
    </div>
    
    <div class="row">
        <!-- 統籌組 -->
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">📊 統籌組</h6>
                </div>
                <div class="card-body">
                    <textarea class="form-control" id="coordination-members" rows="6" 
                              placeholder="輸入人員姓名，一行一個" 
                              oninput="updateMemberCount('coordination')"></textarea>
                    <small class="text-muted mt-2 d-block">
                        目前人數: <span id="coordination-count" class="fw-bold text-info">0</span>
                    </small>
                </div>
            </div>
        </div>
        
        <!-- 燈光組 -->
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">💡 燈光組</h6>
                </div>
                <div class="card-body">
                    <textarea class="form-control" id="lighting-members" rows="6" 
                              placeholder="輸入人員姓名，一行一個"
                              oninput="updateMemberCount('lighting')"></textarea>
                    <small class="text-muted mt-2 d-block">
                        目前人數: <span id="lighting-count" class="fw-bold text-warning">0</span>
                    </small>
                </div>
            </div>
        </div>
        
        <!-- 舞台組 -->
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">🎭 舞台組</h6>
                </div>
                <div class="card-body">
                    <textarea class="form-control" id="stage-members" rows="6" 
                              placeholder="輸入人員姓名，一行一個"
                              oninput="updateMemberCount('stage')"></textarea>
                    <small class="text-muted mt-2 d-block">
                        目前人數: <span id="stage-count" class="fw-bold text-success">0</span>
                    </small>
                </div>
            </div>
        </div>
        
        <!-- 視聽組 -->
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0">🔊 視聽組</h6>
                </div>
                <div class="card-body">
                    <textarea class="form-control" id="audiovisual-members" rows="6" 
                              placeholder="輸入人員姓名，一行一個"
                              oninput="updateMemberCount('audiovisual')"></textarea>
                    <small class="text-muted mt-2 d-block">
                        目前人數: <span id="audiovisual-count" class="fw-bold text-danger">0</span>
                    </small>
                </div>
            </div>
        </div>
        
        <!-- 維護組 -->
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">🔧 維護組</h6>
                </div>
                <div class="card-body">
                    <textarea class="form-control" id="maintenance-members" rows="6" 
                              placeholder="輸入人員姓名，一行一個"
                              oninput="updateMemberCount('maintenance')"></textarea>
                    <small class="text-muted mt-2 d-block">
                        目前人數: <span id="maintenance-count" class="fw-bold text-secondary">0</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 群組操作按鈕 -->
    <div class="text-center mt-4">
        <button class="btn btn-primary btn-lg" onclick="saveGroupSettings()">
            <i class="fas fa-save"></i> 儲存群組設定
        </button>
        <button class="btn btn-secondary btn-lg ms-2" onclick="loadGroupSettings()">
            <i class="fas fa-download"></i> 重新載入設定
        </button>
        <button class="btn btn-warning btn-lg ms-2" onclick="clearAllGroups()">
            <i class="fas fa-trash"></i> 清空所有群組
        </button>
    </div>
</div>

<script>
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    const uploadBtn = document.getElementById('uploadBtn');
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 處理中...';
    uploadBtn.disabled = true;
});

// 檔案選擇後顯示版本
document.getElementById('file').addEventListener('change', function(e) {
    const fileName = e.target.files[0]?.name || '';
    const detectedVersionSpan = document.getElementById('detectedVersion');
    
    if (fileName) {
        // 統一使用一般版本
        detectedVersionSpan.textContent = '一般版本';
        detectedVersionSpan.className = 'fw-bold text-success';
        
        // 添加短暫的閃爍效果
        detectedVersionSpan.style.backgroundColor = '#d4edda';
        setTimeout(() => {
            detectedVersionSpan.style.backgroundColor = '';
        }, 1000);
    } else {
        detectedVersionSpan.textContent = '一般版本';
        detectedVersionSpan.className = 'fw-bold text-info';
    }
});

function toggleShowAll() {
    const toggleText = document.getElementById('toggleText');
    const tableBody = document.getElementById('previewTableBody');
    
    if (toggleText.textContent === '查看全部') {
        // 這裡可以通過AJAX加載更多數據
        toggleText.textContent = '收合';
        // 暫時只是修改文字，實際實現需要後端支援
    } else {
        toggleText.textContent = '查看全部';
    }
}

function filterTable(status) {
    const table = document.getElementById('previewTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    // 重置按鈕樣式
    document.getElementById('filterAll').className = 'btn btn-sm btn-outline-secondary';
    document.getElementById('filterWarning').className = 'btn btn-sm btn-outline-warning';
    document.getElementById('filterError').className = 'btn btn-sm btn-outline-danger';
    
    // 設置當前按鈕為選中狀態
    if (status === 'all') {
        document.getElementById('filterAll').className = 'btn btn-sm btn-secondary';
    } else if (status === 'warning') {
        document.getElementById('filterWarning').className = 'btn btn-sm btn-warning';
    } else if (status === 'error') {
        document.getElementById('filterError').className = 'btn btn-sm btn-danger';
    }
    
    // 過濾行
    for (let i = 0; i < rows.length; i++) {
        const rowStatus = rows[i].getAttribute('data-status');
        if (status === 'all' || rowStatus === status) {
            rows[i].style.display = '';
        } else {
            rows[i].style.display = 'none';
        }
    }
}

function sortTable(columnIndex) {
    const table = document.getElementById('previewTable');
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    // 獲取排序方向
    const currentSort = table.getAttribute('data-sort-column');
    const currentDirection = table.getAttribute('data-sort-direction') || 'asc';
    const newDirection = (currentSort == columnIndex && currentDirection === 'asc') ? 'desc' : 'asc';
    
    // 排序行
    rows.sort((a, b) => {
        const aText = a.cells[columnIndex].textContent.trim();
        const bText = b.cells[columnIndex].textContent.trim();
        
        // 數字比較（對行號欄位）
        if (columnIndex === 0) {
            const aNum = parseInt(aText) || 0;
            const bNum = parseInt(bText) || 0;
            return newDirection === 'asc' ? aNum - bNum : bNum - aNum;
        }
        
        // 文字比較
        const comparison = aText.localeCompare(bText, 'zh-TW');
        return newDirection === 'asc' ? comparison : -comparison;
    });
    
    // 重新插入排序後的行
    rows.forEach(row => tbody.appendChild(row));
    
    // 更新排序狀態
    table.setAttribute('data-sort-column', columnIndex);
    table.setAttribute('data-sort-direction', newDirection);
    
    // 更新排序圖標
    const headers = table.getElementsByTagName('th');
    for (let i = 0; i < headers.length; i++) {
        const icon = headers[i].querySelector('i');
        if (icon) {
            if (i === columnIndex) {
                icon.className = newDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            } else {
                icon.className = 'fas fa-sort';
            }
        }
    }
}

// 上傳進度處理
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    // 顯示進度提示
    document.getElementById('uploadBtnText').style.display = 'none';
    document.getElementById('uploadBtnSpinner').style.display = 'inline';
    document.getElementById('uploadBtn').disabled = true;
    document.getElementById('progressArea').style.display = 'block';
    
    // 模擬進度更新
    let progress = 0;
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        
        progressBar.style.width = progress + '%';
        
        if (progress < 30) {
            progressText.textContent = '正在讀取CSV文件...';
        } else if (progress < 60) {
            progressText.textContent = '正在驗證數據格式...';
        } else if (progress < 90) {
            progressText.textContent = '正在分析班表數據...';
        }
    }, 300);
    
    // 表單提交完成後清理
    setTimeout(() => {
        clearInterval(interval);
    }, 10000);
});

// 群組管理功能
const groupIds = ['coordination', 'lighting', 'stage', 'audiovisual', 'maintenance'];
const groupNames = {
    'coordination': '統籌組',
    'lighting': '燈光組', 
    'stage': '舞台組',
    'audiovisual': '視聽組',
    'maintenance': '維護組'
};

// 自動計算人數
function updateMemberCount(groupId) {
    const textarea = document.getElementById(groupId + '-members');
    const countSpan = document.getElementById(groupId + '-count');
    const names = textarea.value.trim().split('\n').filter(name => name.trim());
    countSpan.textContent = names.length;
}

// 載入群組設定
async function loadGroupSettings() {
    try {
        const response = await fetch('/api/group-members');
        const result = await response.json();
        
        if (result.status === 'success') {
            const data = result.data;
            
            groupIds.forEach(groupId => {
                const groupName = groupNames[groupId];
                const textarea = document.getElementById(groupId + '-members');
                const members = data[groupName] || [];
                textarea.value = members.join('\n');
                updateMemberCount(groupId);
            });
            
            console.log('群組設定載入成功');
        } else {
            console.error('載入群組設定失敗:', result.message);
        }
    } catch (error) {
        console.error('載入群組設定錯誤:', error);
    }
}

// 儲存群組設定
async function saveGroupSettings() {
    try {
        const groupData = {};
        
        groupIds.forEach(groupId => {
            const groupName = groupNames[groupId];
            const textarea = document.getElementById(groupId + '-members');
            const names = textarea.value.trim().split('\n')
                           .map(name => name.trim())
                           .filter(name => name);
            groupData[groupName] = names;
        });
        
        const response = await fetch('/api/group-members', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(groupData)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('✅ 群組設定已儲存！');
            // 重新載入以確認儲存成功
            await loadGroupSettings();
        } else {
            alert('❌ 儲存失敗: ' + result.message);
        }
    } catch (error) {
        console.error('儲存群組設定錯誤:', error);
        alert('❌ 儲存時發生錯誤，請稍後再試');
    }
}

// 清空所有群組
function clearAllGroups() {
    if (confirm('確定要清空所有群組的人員名單嗎？')) {
        groupIds.forEach(groupId => {
            const textarea = document.getElementById(groupId + '-members');
            textarea.value = '';
            updateMemberCount(groupId);
        });
        alert('已清空所有群組');
    }
}

// 初始化：預設顯示全部並載入群組設定
window.onload = function() {
    if (document.getElementById('filterAll')) {
        filterTable('all');
    }
    
    // 載入群組設定
    loadGroupSettings();
};
</script>
{% endblock %}